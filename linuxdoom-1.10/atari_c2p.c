#include <mint/osbind.h>
#include "atari_c2p.h"
#include "r_main.h"
#include "w_wad.h"
#include "z_zone.h"
#include "doomdef.h"

// Set to 1 to use grayscale medium resolution (640x200) rendering.
#define USE_MIDRES 0

#if !USE_MIDRES
static void move_p_ofs(unsigned char *p, unsigned int data, unsigned char ofs) {
	asm ("movep.l %0, %c2(%1)" : : "d" (data), "a" (p), "i" (ofs));
}

// Subset of DOOM colors to use for Atari palette
const unsigned char subset[] = 
    {0, 90, 101, 241, 202, 252, 38, 219, 144, 136, 158, 120, 72, 58, 249, 4};

// [DOOM color 0..255][weight of ST color 0..16]
static unsigned char mix_weights[256][16] = {
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 0: 0.000000
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 1: 0.272184
{ 13, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 2: 0.184346
{ 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 3: 0.520806
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 4: 0.000000
{ 13, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 5: 0.256163
{ 12, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 6: 0.189949
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 7: 0.066903
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 8: 0.024751
{ 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0,}, // 9: 0.237515
{ 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 10: 0.246313
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 11: 0.265254
{ 12, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 12: 0.220426
{ 0, 0, 0, 2, 0, 0, 4, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 13: 0.344584
{ 5, 0, 0, 0, 0, 0, 3, 0, 0, 0, 8, 0, 0, 0, 0, 0,}, // 14: 0.383413
{ 8, 0, 0, 0, 0, 0, 3, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 15: 0.435479
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 4,}, // 16: 3.650220
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 4, 0,}, // 17: 3.304493
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 18: 2.593026
{ 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0,}, // 19: 1.674132
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0,}, // 20: 1.143260
{ 0, 0, 0, 0, 0, 4, 0, 3, 0, 0, 0, 0, 0, 9, 0, 0,}, // 21: 1.917287
{ 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 6, 0, 0,}, // 22: 1.767075
{ 0, 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 23: 1.536222
{ 0, 2, 0, 0, 0, 3, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 24: 1.515017
{ 0, 0, 0, 0, 0, 2, 0, 9, 5, 0, 0, 0, 0, 0, 0, 0,}, // 25: 0.910264
{ 0, 0, 0, 0, 0, 2, 0, 8, 0, 6, 0, 0, 0, 0, 0, 0,}, // 26: 1.111782
{ 0, 0, 6, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 27: 1.250513
{ 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0,}, // 28: 1.326627
{ 0, 0, 0, 6, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 29: 1.434581
{ 0, 0, 0, 0, 0, 0, 9, 7, 0, 0, 0, 0, 0, 0, 0, 0,}, // 30: 1.294722
{ 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0,}, // 31: 1.170698
{ 0, 0, 0, 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 32: 1.322348
{ 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 33: 1.086671
{ 0, 0, 0, 0, 0, 0, 13, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 34: 1.058583
{ 0, 0, 0, 0, 0, 0, 14, 2, 0, 0, 0, 0, 0, 0, 0, 0,}, // 35: 1.088789
{ 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 5, 0, 0, 0,}, // 36: 0.794256
{ 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 3, 0, 0, 0,}, // 37: 0.579937
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 38: 0.000000
{ 1, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 39: 0.360195
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 40: 0.378826
{ 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 41: 0.367846
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 42: 0.387673
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 43: 0.401103
{ 9, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 44: 0.316330
{ 10, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 45: 0.343415
{ 11, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 46: 0.312668
{ 12, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 47: 0.356765
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 12,}, // 48: 2.623721
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 1, 10,}, // 49: 2.974666
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 8,}, // 50: 2.957835
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 3, 6,}, // 51: 3.147999
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 7,}, // 52: 3.223139
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 6,}, // 53: 3.404847
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 0,}, // 54: 3.038212
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 7, 0,}, // 55: 2.809125
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 5, 0,}, // 56: 2.578156
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 3, 0,}, // 57: 1.981593
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 58: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 13, 0, 0,}, // 59: 1.301554
{ 0, 2, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 9, 0, 0,}, // 60: 1.625214
{ 0, 3, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 5, 0, 0,}, // 61: 1.546009
{ 0, 0, 0, 0, 0, 0, 0, 6, 5, 0, 0, 0, 0, 5, 0, 0,}, // 62: 1.515526
{ 0, 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 63: 1.112219
{ 0, 2, 0, 0, 0, 0, 0, 8, 6, 0, 0, 0, 0, 0, 0, 0,}, // 64: 1.151477
{ 0, 0, 0, 0, 0, 0, 0, 6, 7, 3, 0, 0, 0, 0, 0, 0,}, // 65: 0.781573
{ 0, 0, 0, 0, 0, 0, 0, 6, 3, 7, 0, 0, 0, 0, 0, 0,}, // 66: 0.890632
{ 0, 0, 0, 0, 0, 0, 0, 5, 0, 11, 0, 0, 0, 0, 0, 0,}, // 67: 0.851335
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 8, 0, 0, 4, 0, 0, 0,}, // 68: 0.953479
{ 0, 0, 0, 0, 0, 0, 0, 3, 0, 5, 0, 0, 8, 0, 0, 0,}, // 69: 1.024666
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 9, 0, 0, 0,}, // 70: 0.848893
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 13, 0, 0, 0,}, // 71: 0.562894
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,}, // 72: 0.000000
{ 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 4, 0, 9, 0, 0, 0,}, // 73: 0.378530
{ 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 8, 0, 4, 0, 0, 0,}, // 74: 0.354626
{ 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 75: 0.189031
{ 4, 0, 0, 0, 0, 0, 4, 0, 0, 0, 8, 0, 0, 0, 0, 0,}, // 76: 0.395758
{ 7, 0, 0, 0, 0, 0, 2, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 77: 0.463859
{ 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 78: 0.381207
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 79: 0.325229
{ 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12,}, // 80: 3.166332
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11,}, // 81: 3.123576
{ 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9,}, // 82: 2.344917
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8,}, // 83: 2.820066
{ 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7,}, // 84: 3.067872
{ 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,}, // 85: 2.799674
{ 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,}, // 86: 3.473246
{ 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,}, // 87: 2.618548
{ 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0,}, // 88: 2.701101
{ 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0,}, // 89: 2.302743
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 90: 0.000000
{ 0, 14, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0,}, // 91: 0.867691
{ 0, 12, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0,}, // 92: 1.257386
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0,}, // 93: 1.548356
{ 0, 9, 6, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,}, // 94: 1.487556
{ 0, 7, 8, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,}, // 95: 1.491882
{ 0, 6, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 96: 1.319530
{ 0, 5, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 97: 1.168878
{ 0, 0, 0, 0, 3, 0, 0, 0, 8, 0, 0, 5, 0, 0, 0, 0,}, // 98: 1.108506
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 5, 0, 0, 0, 0,}, // 99: 0.913823
{ 0, 0, 7, 0, 0, 0, 0, 0, 0, 6, 0, 3, 0, 0, 0, 0,}, // 100: 0.736361
{ 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 101: 0.000000
{ 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 102: 0.433284
{ 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 103: 0.429390
{ 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0,}, // 104: 0.497539
{ 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0,}, // 105: 0.519945
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 106: 0.290279
{ 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 107: 0.294263
{ 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 108: 0.265965
{ 5, 0, 0, 4, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 109: 0.333991
{ 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 110: 0.284183
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 111: 0.268954
{ 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7,}, // 112: 10.206682
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0,}, // 113: 8.881993
{ 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0,}, // 114: 7.573062
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 115: 5.199405
{ 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0,}, // 116: 4.762754
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0,}, // 117: 3.574536
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0,}, // 118: 2.571867
{ 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 11, 0, 0, 0, 0,}, // 119: 2.030618
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0,}, // 120: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 10, 0, 0, 0, 0,}, // 121: 0.579462
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 5, 0, 0, 0, 0,}, // 122: 0.718139
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 123: 0.587915
{ 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0,}, // 124: 0.514047
{ 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 125: 0.376693
{ 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0,}, // 126: 0.296209
{ 12, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 127: 0.205969
{ 0, 9, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 5, 0, 0,}, // 128: 1.497253
{ 0, 12, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 129: 1.198147
{ 0, 8, 0, 0, 0, 0, 0, 3, 5, 0, 0, 0, 0, 0, 0, 0,}, // 130: 1.378013
{ 0, 5, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0,}, // 131: 1.043332
{ 0, 1, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0,}, // 132: 0.903190
{ 0, 0, 0, 0, 0, 0, 0, 0, 14, 2, 0, 0, 0, 0, 0, 0,}, // 133: 0.587902
{ 0, 0, 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0,}, // 134: 0.526966
{ 0, 0, 0, 0, 0, 0, 0, 0, 5, 11, 0, 0, 0, 0, 0, 0,}, // 135: 0.502405
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 136: 0.000000
{ 0, 0, 2, 0, 0, 0, 0, 0, 0, 9, 0, 0, 5, 0, 0, 0,}, // 137: 0.406830
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 6, 0, 0, 7, 0, 0, 0,}, // 138: 0.385213
{ 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0,}, // 139: 0.218806
{ 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 4, 0, 8, 0, 0, 0,}, // 140: 0.370488
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8, 0, 0, 0,}, // 141: 0.344300
{ 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 11, 0, 3, 0, 0, 0,}, // 142: 0.405204
{ 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 143: 0.248297
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 144: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0,}, // 145: 0.577321
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 146: 0.281518
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 5, 0, 0, 8, 0, 0, 0,}, // 147: 0.486727
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 4, 0, 9, 0, 0, 0,}, // 148: 0.455360
{ 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 9, 0, 5, 0, 0, 0,}, // 149: 0.369267
{ 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 150: 0.367183
{ 6, 0, 0, 0, 0, 0, 3, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 151: 0.387597
{ 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 8, 0, 0, 0, 0,}, // 152: 0.906462
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 6, 0, 0, 0, 0,}, // 153: 0.378200
{ 0, 0, 10, 0, 0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 0,}, // 154: 0.531748
{ 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0,}, // 155: 0.660752
{ 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0,}, // 156: 0.530332
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0,}, // 157: 0.394763
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 158: 0.000000
{ 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 159: 0.249537
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8,}, // 160: 4.162416
{ 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0,}, // 161: 2.148563
{ 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 8, 0,}, // 162: 2.792022
{ 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 7, 0, 0,}, // 163: 2.066245
{ 0, 0, 0, 0, 0, 0, 0, 4, 12, 0, 0, 0, 0, 0, 0, 0,}, // 164: 1.185234
{ 0, 0, 0, 0, 0, 0, 0, 5, 0, 1, 0, 0, 10, 0, 0, 0,}, // 165: 1.085748
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,}, // 166: 0.883151
{ 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 2, 0, 0, 0,}, // 167: 0.374443
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 168: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 10,}, // 169: 3.174720
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 5,}, // 170: 3.458503
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 171: 2.962659
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 12, 0, 0,}, // 172: 3.532310
{ 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 7, 0, 0,}, // 173: 4.179040
{ 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 4, 0, 0,}, // 174: 4.730371
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 175: 4.710289
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 176: 4.602677
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 177: 2.992067
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 178: 3.362016
{ 0, 0, 0, 0, 0, 0, 4, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 179: 3.053726
{ 0, 0, 0, 0, 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 180: 2.706753
{ 0, 0, 0, 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 181: 2.380003
{ 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0,}, // 182: 2.111907
{ 0, 0, 0, 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 183: 1.867038
{ 0, 0, 0, 0, 0, 0, 13, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 184: 1.633975
{ 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 6, 0, 0, 0,}, // 185: 1.262221
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 186: 0.496956
{ 2, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 187: 0.406059
{ 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 188: 0.373039
{ 8, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 189: 0.412317
{ 10, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 190: 0.343415
{ 12, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 191: 0.356765
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11,}, // 192: 3.841664
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 193: 5.367082
{ 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7,}, // 194: 5.475929
{ 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,}, // 195: 5.871679
{ 0, 9, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 196: 5.476518
{ 0, 5, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 197: 5.098670
{ 0, 3, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 198: 4.920499
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 199: 4.526933
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 200: 4.246955
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 201: 1.816516
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 202: 0.000000
{ 4, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 203: 0.433734
{ 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 204: 0.362622
{ 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 205: 0.350592
{ 12, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 206: 0.417588
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 207: 0.264925
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 208: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 12,}, // 209: 2.829965
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 6,}, // 210: 3.028446
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 10, 0,}, // 211: 3.034245
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 5, 0,}, // 212: 2.465947
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 213: 2.743993
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 214: 3.277970
{ 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 11, 0, 0,}, // 215: 3.758439
{ 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 7, 0, 0,}, // 216: 2.869378
{ 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 5, 0, 0,}, // 217: 2.251907
{ 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 2, 0, 0,}, // 218: 1.410058
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 219: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 3, 0, 0, 0,}, // 220: 1.102003
{ 0, 0, 0, 0, 0, 0, 5, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 221: 1.276982
{ 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0, 0, 0,}, // 222: 1.077685
{ 0, 0, 0, 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 223: 1.165833
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 224: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 13,}, // 225: 2.163744
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 11,}, // 226: 3.061654
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 9,}, // 227: 3.741459
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8,}, // 228: 4.277575
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 7,}, // 229: 4.617553
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 6,}, // 230: 4.818816
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 6,}, // 231: 4.860993
{ 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0,}, // 232: 1.299419
{ 0, 0, 0, 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 233: 1.037858
{ 0, 0, 0, 0, 0, 0, 13, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 234: 1.198149
{ 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 7, 0, 0, 0,}, // 235: 1.024814
{ 0, 0, 0, 2, 0, 0, 4, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 236: 0.344760
{ 7, 0, 0, 0, 0, 0, 3, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 237: 0.387113
{ 11, 0, 0, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 0, 0,}, // 238: 0.465596
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 239: 0.417457
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 240: 0.264925
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 241: 0.000000
{ 5, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 242: 0.051434
{ 10, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 243: 0.055350
{ 13, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 244: 0.052277
{ 15, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 245: 0.050944
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 246: 0.010683
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 247: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 248: 2.291992
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 249: 0.000000
{ 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 250: 6.801280
{ 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0,}, // 251: 6.971362
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 252: 0.000000
{ 7, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 253: 1.333829
{ 0, 0, 0, 0, 4, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 254: 0.655883
{ 0, 0, 0, 0, 0, 0, 0, 4, 5, 7, 0, 0, 0, 0, 0, 0,}, // 255: 1.239415
};
#endif

// C2P table for full resolution
// [phase 0..3][color 0..255][pixel 0..7]
static unsigned long c2p_table[4][256][8];

// C2P table for half resolution (2x2 pixels)
// [phase 0..3][color 0..255][pixel 0..3]
static unsigned long c2p_2x_table[4][256][4];

static unsigned short convert_channel(unsigned char v) {
    unsigned short r = (v & 0xe0) >> 5; // Bits 7,6,5 shifted to 2,1,0
    r |= (v & 0x10) >> 1; // STe color bit
    return r;
}
static unsigned short stcolor(unsigned char r, unsigned char g, unsigned char b) {
    unsigned short entry = convert_channel(r);
    entry <<= 4;
    entry |= convert_channel(g);
    entry <<= 4;
    entry |= convert_channel(b);
    return entry;
}

void install_palette(unsigned short *palette) {
    volatile unsigned short *reg = (unsigned short*) 0xff8240;
#if USE_MIDRES
    short numColors = 4;
#else
    short numColors = 16;
#endif
    for (short n=0; n<numColors; n++) *reg++ = *palette++;
}

void init_c2p_table() {
	unsigned short bayer[4][4] = {
		{0,  8, 2,10},
		{12, 4,14, 6},
		{ 3,11, 1, 9},
		{15, 7,13, 5}
	};
    set_doom_palette(W_CacheLumpName("PLAYPAL", PU_CACHE));
#if USE_MIDRES
    unsigned short stpalette[] = {stcolor(0,0,0), stcolor(85,85,85), stcolor(170,170,170), stcolor(255,255,255)};
    install_palette(stpalette);

    unsigned char* palette = W_CacheLumpName("PLAYPAL", PU_CACHE);
    for (int i=0; i<256; i++) {
        unsigned short r=palette[3*i], g=palette[3*i+1], b=palette[3*i+2];
        // printf("C %d: %d %d %d\n", i, r, g, b);
        // calculate brightness (0..765)
        unsigned short l = r+g+b;
        // calculate weights (0..255) of color indices 0, 1, 2, 3
        unsigned short w[] = {
            l < 256 ? 255 - l : 0,
            l < 256 ? l : (l < 512 ? 511 - l : 0),
            l < 256 ? 0 : (l < 512 ? l - 256 : 767 - l),
            l < 512 ? 0 : (l - 512),
        };
        // make weights cumulative
        for (int j=0; j<3; j++) w[j+1] += w[j];
        // renormalize weights into bayer range 0..15
        // for (int j=0; j<4; j++) w[j] >>= 4;
        // printf("  w: %2d %2d %2d %2d\n", w[0], w[1], w[2], w[3]);

        for (int phase=0; phase<4; phase++) {
            // iterate over 8 consecutive input pixels
            unsigned long combined_pdata = 0;
            for (int px = 0; px < 8; px++) {
                unsigned long pdata = 0;
                // per input pixel, iterate over two output pixels
                for (int opx = 2*px; opx < 2*px+2; opx++) {
                    // Fetch bayer threshold for output pixel.
                    unsigned short bayer_w = (bayer[phase][opx % 4] << 4) + 7;
                    // Iterate four possible output colors.
                    // Select first one that has cumulative weight >= bayer threshold.
                    // Apply bits to pixel data in opx position.
                    for (int oc = 0; oc < 4; oc++) {
                        if (oc < 3 && w[oc] < bayer_w) continue;
                        if (oc & 1) pdata |= 0x80000000 >> opx;
                        if (oc & 2) pdata |= 0x00008000 >> opx;
                        break;
                    }
                }
                c2p_table[phase][i][px] = pdata;
                combined_pdata |= pdata;
            }
        }
    }
#else
	for (int i=0; i<256; i++) {
        unsigned char *weights = mix_weights[i];
        for (int phase=0; phase<4; phase++) {
            for (int px=0; px<8; px++) {
                // Find the ST palette color index to fill the pixel with.
                int bayer_lwb = 0, bayer_upb = 0;
                for (int c=0; c<16; c++) {
                    bayer_upb += weights[c];
                    if (bayer[phase][px%4] >= bayer_lwb && bayer[phase][px%4] < bayer_upb) {
                        unsigned long pdata = 0;
                        if (c & 1) pdata |= 0x01000000;
                        if (c & 2) pdata |= 0x00010000;
                        if (c & 4) pdata |= 0x00000100;
                        if (c & 8) pdata |= 0x00000001;
                        pdata <<= 7-px;
                        c2p_table[phase][i][px] = pdata;
                        break; // Search for color is finished. Continue with next pixel.
                    }
                    bayer_lwb += weights[c];
                }
            }
        }
	}
	for (int i=0; i<256; i++) {
        unsigned char *weights = mix_weights[i];
        for (int phase=0; phase<4; phase++) {
            for (int ipx=0; ipx<4; ipx++) {
                unsigned long ipx_pdata = 0;
                for (int opx=2*ipx; opx<2*ipx+2; opx++) {
                    // Find the ST palette color index to fill the pixel with.
                    int bayer_lwb = 0, bayer_upb = 0;
                    for (int c=0; c<16; c++) {
                        bayer_upb += weights[c];
                        if (bayer[phase][opx%4] >= bayer_lwb && bayer[phase][opx%4] < bayer_upb) {
                            unsigned long pdata = 0;
                            if (c & 1) pdata |= 0x01000000;
                            if (c & 2) pdata |= 0x00010000;
                            if (c & 4) pdata |= 0x00000100;
                            if (c & 8) pdata |= 0x00000001;
                            pdata <<= 7-opx;
                            ipx_pdata |= pdata;
                            break; // Search for color is finished. Continue with next pixel.
                        }
                        bayer_lwb += weights[c];
                    }
                }
                c2p_2x_table[phase][i][ipx] = ipx_pdata;
            }
        }
	}
#endif
}

static void c2p(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]) {
#if USE_MIDRES
	while (pixels > 7) {
		register unsigned long pdata = 0;
        for(int i=0; i<8; i++) {
            pdata |= table[*in++][i];
        }
        *(unsigned long*)out = pdata;
		pixels -= 8;
		out += 4;
	}
#else
    if (pixels < 16) return;
    unsigned short groups = pixels / 16 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned long mask = 0x00ff00ff<<5; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read eight consecutive pixels from buffer into two 32 bit registers
        "movem.l    (%[in])+, %%d0-%%d1             \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "move.l     %%d0,%%d2                       \n\t"
        "lsr.l      #3,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d2.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d2                            \n\t"
        "or.l       (%[table],%%d2.w), %[pdata]     \n\t"

        // Prepare pixels 5,7
        "move.l     %%d1,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 7
        "or.l       28(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 5
        "swap       %%d2                            \n\t"
        "or.l       20(%[table],%%d2.w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "move.l     %%d1,%%d2                       \n\t"
        "lsr.l      #3,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 6
        "or.l       24(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %%d2                            \n\t"
        "or.l       16(%[table],%%d2.w), %[pdata]   \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 0(%[out])             \n\t"

        // Read another eight consecutive pixels from buffer into two 32 bit registers
        "movem.l    (%[in])+, %%d0-%%d1             \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "move.l     %%d0,%%d2                       \n\t"
        "lsr.l      #3,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d2.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d2                            \n\t"
        "or.l       (%[table],%%d2.w), %[pdata]     \n\t"

        // Prepare pixels 5,7
        "move.l     %%d1,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 7
        "or.l       28(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 5
        "swap       %%d2                            \n\t"
        "or.l       20(%[table],%%d2.w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "move.l     %%d1,%%d2                       \n\t"
        "lsr.l      #3,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 6
        "or.l       24(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %%d2                            \n\t"
        "or.l       16(%[table],%%d2.w), %[pdata]   \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 1(%[out])             \n\t"
        
        // Advance out address by 16 pixels (8 bytes) and loop
        "lea        8(%[out]), %[out]               \n\t"
        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d1", "d2", "memory"
    );
#endif
}

#if !USE_MIDRES
static void c2p_2x(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][4]) {
    short groups = pixels / 8;
    while (groups-- > 0) {
        for (short j=0; j<2; j++) {
            unsigned long pdata = 0;
            for (short i=0; i<4; i++) {
                pdata |= table[*in++][i];
            }
            move_p_ofs(out, pdata, j);
        }
        out += 8;
    }
}
#endif

void set_doom_palette(const unsigned char *colors) {
#if USE_MIDRES
    // do nothing
#else
    unsigned short stpalette[sizeof(subset)];
    for (int i=0; i<sizeof(subset); i++) {
        const unsigned char *c = &colors[3*subset[i]];
        stpalette[i] = stcolor(c[0], c[1], c[2]);
    }
    install_palette(stpalette);
#endif
}

void draw_palette_table(unsigned char *st_screen) {
    unsigned char buf[128+16];
	unsigned char c = 0;
	for (int y=0; y<128; y+=8) {
		for (int x=0; x<128; x+=8) {
			for (int i=0; i<8; i++) buf[x+i] = c;
            for (int i=0; i<16; i++) {
                if (c == subset[i]) {
                    buf[x] = 4;
                    buf[x+7] = 0;
                }
            }
			c++;
		}
        for (int x=128; x<128+8; x++) buf[x] = 0;
        for (int x=128+8; x<128+16; x++) buf[x] = subset[y/8];
		for (int i=0; i<8; i++) c2p(st_screen + 160*(32+y+i), buf, 128+16, c2p_table[i%4]);
	}
}

extern boolean inhelpscreens;
extern boolean menuactive;
extern boolean automapactive;
extern gamestate_t gamestate;

void c2p_screen(unsigned char *out, const unsigned char *in) {
#if USE_MIDRES
    for (int line = 0; line < SCREENHEIGHT; line++ ) {
	    c2p(out + 160*line, in + 320*line, 320, c2p_table[line&3]);
    }
#else
    int splitline = 0;
    boolean zoom_allowed = gamestate == GS_LEVEL
        && !menuactive && !inhelpscreens && !automapactive;
    if (zoom_allowed && viewwidth <= SCREENWIDTH/2) {
        splitline = 200-32;
        for (int line = 0; line < splitline; line++ ) {
            c2p_2x(out + 160*line, in + SCREENWIDTH*(42 + line/2) + 80, 160, c2p_2x_table[line&3]);
        }
    }
    for (int line = splitline; line < SCREENHEIGHT; line++ ) {
	    c2p(out + 160*line, in + 320*line, 320, c2p_table[line&3]);
    }
#endif
}