#include <mint/osbind.h>
#include "atari_c2p.h"
#include "i_system.h"
#include "r_main.h"
#include "w_wad.h"
#include "z_zone.h"
#include "doomdef.h"

// Subset of DOOM colors to use for Atari palette
const unsigned char subset_lorez[] = 
    {0, 88, 102, 205, 184, 6, 42, 217, 144, 136, 159, 121, 72, 56, 249, 4};
const unsigned char subset_midrez[] = 
    {0, 166, 156, 210, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
const unsigned char subset_hirez[] = 
    {0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
const unsigned char *subset;
short num_colors;

// Some function pointers depending on screen resolution.
void (*c2p_statusbar_drawfunc)(unsigned char *out, const unsigned char *in, short y_begin, short y_end, short x_begin, short x_end);
void (*c2p_screen_drawfunc)(unsigned char *out, const unsigned char *in);


// [DOOM color 0..255][ST color 0..15]
static unsigned char mix_weights_lorez[256][16] = {
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 0: 0.000000
{ 0, 0, 0, 0, 0, 14, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 1: 1.029696
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 2: 0.477274
{ 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0,}, // 3: 1.623919
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 4: 0.000000
{ 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 5: 1.212882
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 6: 0.000000
{ 9, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 7: 0.227810
{ 13, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 8: 0.216746
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 9: 1.049474
{ 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 10: 1.340502
{ 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 11: 1.298917
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 12: 0.308680
{ 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0,}, // 13: 1.970278
{ 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 14: 0.927805
{ 0, 0, 0, 0, 0, 3, 5, 0, 0, 0, 8, 0, 0, 0, 0, 0,}, // 15: 1.377477
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 3, 0,}, // 16: 6.606329
{ 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0,}, // 17: 3.829956
{ 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0,}, // 18: 5.610569
{ 0, 5, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 6, 0, 0,}, // 19: 6.244510
{ 0, 5, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 4, 0, 0,}, // 20: 6.435039
{ 0, 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0,}, // 21: 4.604540
{ 0, 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 22: 5.310085
{ 0, 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0,}, // 23: 4.846436
{ 0, 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0, 0,}, // 24: 3.980491
{ 0, 0, 0, 0, 0, 0, 0, 9, 0, 7, 0, 0, 0, 0, 0, 0,}, // 25: 4.368187
{ 0, 0, 0, 0, 0, 0, 0, 6, 0, 10, 0, 0, 0, 0, 0, 0,}, // 26: 4.917404
{ 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0,}, // 27: 5.328965
{ 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 10, 0, 0, 0,}, // 28: 5.253018
{ 0, 0, 0, 0, 8, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0,}, // 29: 5.262059
{ 0, 0, 0, 0, 10, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0,}, // 30: 4.276737
{ 0, 0, 0, 0, 11, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0,}, // 31: 3.937331
{ 0, 0, 0, 0, 10, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0,}, // 32: 2.840506
{ 0, 0, 0, 0, 11, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0,}, // 33: 2.214927
{ 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0,}, // 34: 1.454430
{ 0, 0, 3, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 35: 1.813019
{ 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 36: 1.650483
{ 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 37: 1.546341
{ 0, 0, 0, 0, 7, 0, 5, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 38: 1.883465
{ 0, 0, 0, 0, 6, 0, 8, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 39: 1.649152
{ 0, 0, 0, 0, 4, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 40: 1.507276
{ 0, 0, 0, 0, 2, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 41: 1.249184
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 42: 0.000000
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 43: 0.644722
{ 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 44: 0.891916
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 45: 1.109057
{ 6, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 46: 1.016773
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 47: 0.965432
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 11,}, // 48: 5.177411
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 10,}, // 49: 4.871598
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8,}, // 50: 4.046643
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 6,}, // 51: 5.000147
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 1, 5,}, // 52: 5.304658
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 4,}, // 53: 4.293380
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 5, 0,}, // 54: 4.558097
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 3, 0,}, // 55: 3.617524
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 56: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 13, 0, 0,}, // 57: 4.222168
{ 0, 3, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 9, 0, 0,}, // 58: 4.754671
{ 0, 3, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 6, 0, 0,}, // 59: 4.750480
{ 0, 8, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 60: 4.911167
{ 0, 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 61: 3.156666
{ 0, 3, 0, 0, 0, 0, 0, 9, 4, 0, 0, 0, 0, 0, 0, 0,}, // 62: 3.817886
{ 0, 2, 0, 0, 0, 0, 0, 8, 6, 0, 0, 0, 0, 0, 0, 0,}, // 63: 3.977701
{ 0, 0, 0, 0, 0, 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0,}, // 64: 1.373804
{ 0, 0, 0, 0, 0, 0, 0, 6, 4, 6, 0, 0, 0, 0, 0, 0,}, // 65: 2.776370
{ 0, 0, 0, 0, 0, 0, 0, 6, 0, 10, 0, 0, 0, 0, 0, 0,}, // 66: 2.592722
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 12, 0, 0, 0, 0, 0, 0,}, // 67: 2.744615
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 68: 3.510901
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 4, 0, 0, 0,}, // 69: 3.131163
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 9, 0, 0, 0,}, // 70: 2.409582
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 13, 0, 0, 0,}, // 71: 1.724001
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,}, // 72: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 11, 0, 0, 0,}, // 73: 1.700303
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8, 0, 0, 0,}, // 74: 1.891080
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 4, 0, 0, 0,}, // 75: 1.979975
{ 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0,}, // 76: 1.589590
{ 0, 0, 0, 0, 0, 2, 5, 0, 0, 0, 9, 0, 0, 0, 0, 0,}, // 77: 1.549830
{ 0, 0, 0, 0, 0, 6, 3, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 78: 1.527733
{ 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 79: 1.557704
{ 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12,}, // 80: 5.482552
{ 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10,}, // 81: 5.952118
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8,}, // 82: 6.546726
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8,}, // 83: 6.206768
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 84: 5.421242
{ 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,}, // 85: 5.317633
{ 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,}, // 86: 5.824476
{ 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0,}, // 87: 5.183497
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 88: 0.000000
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 89: 2.842689
{ 0, 12, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0,}, // 90: 3.802150
{ 0, 10, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0,}, // 91: 4.074555
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0,}, // 92: 4.762781
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0,}, // 93: 5.150167
{ 0, 9, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 94: 4.810864
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 95: 4.290232
{ 0, 0, 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0,}, // 96: 4.744104
{ 0, 0, 0, 0, 0, 0, 0, 0, 9, 7, 0, 0, 0, 0, 0, 0,}, // 97: 4.503628
{ 0, 0, 0, 0, 0, 0, 0, 0, 4, 12, 0, 0, 0, 0, 0, 0,}, // 98: 4.125696
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 99: 2.860564
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 5, 0, 0, 0, 0,}, // 100: 2.806951
{ 0, 0, 11, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0,}, // 101: 1.878525
{ 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 102: 0.000000
{ 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,}, // 103: 1.337263
{ 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,}, // 104: 1.556634
{ 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 105: 1.677610
{ 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0,}, // 106: 1.737176
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 107: 0.852271
{ 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0,}, // 108: 1.210562
{ 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0,}, // 109: 1.475311
{ 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 110: 1.262188
{ 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 111: 1.237604
{ 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0,}, // 112: 17.990597
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 113: 14.739158
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 114: 12.234357
{ 0, 10, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0,}, // 115: 13.539312
{ 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0,}, // 116: 11.860241
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0,}, // 117: 10.296955
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0,}, // 118: 8.739961
{ 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 8, 0, 0, 0, 0,}, // 119: 7.082766
{ 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 12, 0, 0, 0, 0,}, // 120: 4.421775
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0,}, // 121: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 10, 0, 0, 0, 0,}, // 122: 1.949190
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0,}, // 123: 2.370519
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 124: 2.094148
{ 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0,}, // 125: 1.822545
{ 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0,}, // 126: 1.371668
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 127: 0.343545
{ 0, 11, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 128: 3.783012
{ 0, 9, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0,}, // 129: 4.435139
{ 0, 6, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0,}, // 130: 3.789106
{ 0, 4, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0,}, // 131: 3.369539
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 132: 2.195340
{ 0, 0, 0, 0, 0, 0, 0, 0, 14, 2, 0, 0, 0, 0, 0, 0,}, // 133: 1.725701
{ 0, 0, 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0,}, // 134: 1.536395
{ 0, 0, 0, 0, 0, 0, 0, 0, 5, 11, 0, 0, 0, 0, 0, 0,}, // 135: 1.340915
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 136: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 6, 0, 0, 0,}, // 137: 1.610181
{ 0, 0, 4, 0, 0, 0, 0, 0, 0, 7, 0, 0, 5, 0, 0, 0,}, // 138: 1.695131
{ 0, 0, 6, 0, 0, 0, 0, 0, 0, 2, 0, 0, 8, 0, 0, 0,}, // 139: 1.421972
{ 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0,}, // 140: 1.507367
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 10, 0, 0, 0,}, // 141: 1.870512
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 7, 0, 0, 0,}, // 142: 1.652756
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 5, 0, 0, 0,}, // 143: 1.775051
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 144: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0,}, // 145: 1.686986
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 146: 0.840398
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 9, 0, 0, 0,}, // 147: 1.611841
{ 0, 0, 5, 0, 5, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0,}, // 148: 1.734216
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8, 0, 0, 0,}, // 149: 1.226622
{ 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0,}, // 150: 1.707536
{ 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 11, 0, 0, 0, 0, 0,}, // 151: 0.779109
{ 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 5, 0, 0, 0, 0,}, // 152: 3.494300
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 153: 2.416871
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 7, 0, 0, 0, 0,}, // 154: 1.719347
{ 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0,}, // 155: 1.732312
{ 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0,}, // 156: 2.143105
{ 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0,}, // 157: 1.755891
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0,}, // 158: 1.583244
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 159: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8,}, // 160: 7.487093
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0,}, // 161: 4.551381
{ 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 8, 0,}, // 162: 6.875154
{ 0, 6, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 163: 6.692525
{ 0, 0, 0, 0, 0, 0, 0, 6, 4, 6, 0, 0, 0, 0, 0, 0,}, // 164: 4.193329
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 12, 0, 0, 0,}, // 165: 3.931978
{ 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0,}, // 166: 1.989281
{ 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0,}, // 167: 1.485654
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 168: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 9,}, // 169: 5.638754
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 3,}, // 170: 6.597437
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 12, 0, 0,}, // 171: 6.169467
{ 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 6, 0, 0,}, // 172: 6.506518
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 173: 5.405806
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 174: 8.417608
{ 0, 0, 0, 0, 5, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 175: 11.132751
{ 0, 0, 0, 0, 6, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 176: 12.203784
{ 0, 0, 0, 0, 8, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 177: 10.545698
{ 0, 0, 0, 0, 9, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0,}, // 178: 9.440520
{ 0, 0, 0, 0, 11, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 179: 8.403698
{ 0, 0, 0, 0, 12, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 180: 7.288400
{ 0, 0, 0, 0, 13, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 181: 6.240082
{ 0, 0, 0, 0, 14, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0,}, // 182: 5.252248
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 183: 2.688333
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 184: 0.000000
{ 0, 0, 0, 0, 11, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 185: 1.100929
{ 0, 0, 0, 0, 8, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 186: 1.134188
{ 0, 0, 0, 0, 5, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 187: 1.271215
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 188: 1.116791
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 189: 0.909562
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 190: 1.109057
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 191: 0.965432
{ 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11,}, // 192: 7.013230
{ 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,}, // 193: 9.744884
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 194: 7.405519
{ 0, 8, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0,}, // 195: 13.491413
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 196: 14.596210
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 197: 15.161194
{ 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 198: 14.221996
{ 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 199: 14.634071
{ 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 200: 14.251876
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 201: 10.790077
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 202: 7.770626
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 203: 4.958267
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 204: 2.363734
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 205: 0.000000
{ 4, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 206: 0.842056
{ 8, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 207: 0.783113
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 208: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 11,}, // 209: 4.880373
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 7,}, // 210: 4.390283
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 7, 0,}, // 211: 5.125590
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 212: 0.733946
{ 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 12, 0, 0,}, // 213: 4.427575
{ 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 8, 0, 0,}, // 214: 5.249959
{ 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 5, 0, 0,}, // 215: 5.886704
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 216: 3.516521
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 217: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 13, 0, 3, 0, 0, 0, 0, 0, 0,}, // 218: 3.915189
{ 0, 0, 0, 0, 4, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 219: 3.800168
{ 0, 0, 0, 0, 6, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 220: 4.111087
{ 0, 0, 0, 0, 7, 0, 0, 8, 0, 1, 0, 0, 0, 0, 0, 0,}, // 221: 4.574028
{ 0, 0, 0, 0, 7, 0, 0, 6, 0, 0, 0, 0, 3, 0, 0, 0,}, // 222: 4.763906
{ 0, 0, 0, 0, 8, 0, 0, 5, 0, 0, 0, 0, 3, 0, 0, 0,}, // 223: 4.542310
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 224: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 13,}, // 225: 4.113408
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 11,}, // 226: 5.413766
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 9,}, // 227: 6.607247
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 7,}, // 228: 7.659527
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 6,}, // 229: 8.533091
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 5,}, // 230: 9.190907
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 4,}, // 231: 9.512803
{ 0, 0, 0, 0, 8, 0, 0, 4, 0, 0, 0, 0, 4, 0, 0, 0,}, // 232: 4.613029
{ 0, 0, 0, 0, 10, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0,}, // 233: 3.764683
{ 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0,}, // 234: 2.008826
{ 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 3, 0, 2, 0, 0, 0,}, // 235: 1.979354
{ 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0,}, // 236: 1.827405
{ 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 9, 0, 0, 0, 0, 0,}, // 237: 1.182365
{ 0, 0, 0, 0, 0, 7, 4, 0, 0, 0, 5, 0, 0, 0, 0, 0,}, // 238: 1.396978
{ 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 239: 1.479859
{ 8, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 240: 0.783113
{ 10, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 241: 0.658060
{ 12, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 242: 0.859428
{ 13, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 243: 0.701189
{ 14, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 244: 0.683770
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 245: 0.473100
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 246: 0.145350
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 247: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 11, 0, 0,}, // 248: 5.331261
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 249: 0.000000
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 250: 14.177117
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 251: 17.488194
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 252: 14.174698
{ 0, 0, 0, 0, 10, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0,}, // 253: 8.219554
{ 0, 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 254: 3.830885
{ 0, 0, 0, 0, 0, 0, 0, 0, 9, 7, 0, 0, 0, 0, 0, 0,}, // 255: 3.931331
};

// [DOOM color 0..255][ST color 0..3]
static unsigned char mix_weights_midrez[256][4] = {
{ 16, 0, 0, 0,}, // 0: 0.000000
{ 14, 0, 2, 0,}, // 1: 1.369409
{ 16, 0, 0, 0,}, // 2: 0.956298
{ 3, 0, 13, 0,}, // 3: 1.996569
{ 0, 0, 0, 16,}, // 4: 14.476759
{ 13, 0, 3, 0,}, // 5: 1.297354
{ 16, 0, 0, 0,}, // 6: 1.091239
{ 16, 0, 0, 0,}, // 7: 0.455137
{ 16, 0, 0, 0,}, // 8: 0.220837
{ 9, 0, 7, 0,}, // 9: 1.280742
{ 11, 0, 5, 0,}, // 10: 1.385516
{ 13, 0, 3, 0,}, // 11: 1.345930
{ 16, 0, 0, 0,}, // 12: 1.135863
{ 6, 4, 6, 0,}, // 13: 1.932729
{ 8, 3, 5, 0,}, // 14: 1.988873
{ 9, 0, 7, 0,}, // 15: 2.096412
{ 0, 3, 0, 13,}, // 16: 7.179754
{ 0, 4, 0, 12,}, // 17: 7.181691
{ 0, 5, 0, 11,}, // 18: 7.426684
{ 0, 6, 0, 10,}, // 19: 7.611697
{ 0, 7, 0, 9,}, // 20: 7.774511
{ 0, 8, 0, 8,}, // 21: 7.543132
{ 0, 9, 0, 7,}, // 22: 8.051924
{ 0, 10, 0, 6,}, // 23: 7.786218
{ 0, 11, 0, 5,}, // 24: 7.542267
{ 0, 12, 0, 4,}, // 25: 7.841898
{ 0, 12, 0, 4,}, // 26: 7.501996
{ 0, 13, 0, 3,}, // 27: 7.313871
{ 0, 14, 0, 2,}, // 28: 7.221093
{ 0, 16, 0, 0,}, // 29: 6.350010
{ 0, 16, 0, 0,}, // 30: 4.624256
{ 0, 16, 0, 0,}, // 31: 3.866672
{ 0, 16, 0, 0,}, // 32: 2.732074
{ 0, 16, 0, 0,}, // 33: 2.476375
{ 0, 16, 0, 0,}, // 34: 2.423065
{ 0, 16, 0, 0,}, // 35: 3.180943
{ 3, 13, 0, 0,}, // 36: 3.614265
{ 4, 12, 0, 0,}, // 37: 3.638918
{ 6, 10, 0, 0,}, // 38: 3.517645
{ 6, 10, 0, 0,}, // 39: 3.532341
{ 7, 9, 0, 0,}, // 40: 3.406162
{ 8, 8, 0, 0,}, // 41: 3.370266
{ 9, 7, 0, 0,}, // 42: 3.197170
{ 10, 6, 0, 0,}, // 43: 3.073067
{ 10, 6, 0, 0,}, // 44: 2.821478
{ 11, 5, 0, 0,}, // 45: 2.760862
{ 12, 4, 0, 0,}, // 46: 2.522095
{ 12, 4, 0, 0,}, // 47: 2.401772
{ 0, 0, 0, 16,}, // 48: 7.144780
{ 0, 0, 0, 16,}, // 49: 4.392898
{ 0, 0, 0, 16,}, // 50: 1.731993
{ 0, 0, 0, 16,}, // 51: 1.029674
{ 0, 0, 0, 16,}, // 52: 2.360215
{ 0, 0, 0, 16,}, // 53: 4.864279
{ 0, 2, 0, 14,}, // 54: 6.889926
{ 0, 3, 0, 13,}, // 55: 7.342029
{ 0, 4, 0, 12,}, // 56: 8.529290
{ 0, 5, 0, 11,}, // 57: 8.237998
{ 0, 6, 0, 10,}, // 58: 7.967037
{ 0, 7, 0, 9,}, // 59: 7.710719
{ 0, 8, 0, 8,}, // 60: 7.469240
{ 0, 9, 0, 7,}, // 61: 7.249010
{ 0, 10, 0, 6,}, // 62: 7.063965
{ 0, 10, 0, 6,}, // 63: 6.695242
{ 0, 11, 0, 5,}, // 64: 5.825050
{ 0, 12, 0, 4,}, // 65: 5.162613
{ 0, 12, 0, 4,}, // 66: 4.730431
{ 0, 13, 0, 3,}, // 67: 4.347106
{ 0, 14, 0, 2,}, // 68: 4.947093
{ 0, 11, 3, 2,}, // 69: 4.841923
{ 0, 16, 0, 0,}, // 70: 3.393552
{ 0, 12, 4, 0,}, // 71: 2.486208
{ 0, 10, 6, 0,}, // 72: 1.304411
{ 0, 7, 9, 0,}, // 73: 1.557672
{ 3, 6, 7, 0,}, // 74: 1.736759
{ 5, 4, 7, 0,}, // 75: 1.727179
{ 7, 4, 5, 0,}, // 76: 1.707610
{ 9, 3, 4, 0,}, // 77: 1.854734
{ 10, 0, 6, 0,}, // 78: 1.596184
{ 12, 0, 4, 0,}, // 79: 1.483997
{ 0, 0, 0, 16,}, // 80: 8.963114
{ 0, 0, 0, 16,}, // 81: 7.172874
{ 0, 0, 0, 16,}, // 82: 6.677398
{ 0, 0, 0, 16,}, // 83: 6.999696
{ 0, 0, 0, 16,}, // 84: 8.523647
{ 0, 0, 3, 13,}, // 85: 9.127682
{ 0, 0, 4, 12,}, // 86: 8.925838
{ 0, 0, 5, 11,}, // 87: 8.527882
{ 0, 0, 6, 10,}, // 88: 8.160164
{ 0, 0, 6, 10,}, // 89: 8.024659
{ 0, 0, 7, 9,}, // 90: 7.672976
{ 0, 0, 8, 8,}, // 91: 7.508930
{ 0, 0, 9, 7,}, // 92: 7.239408
{ 0, 0, 10, 6,}, // 93: 7.030149
{ 0, 0, 10, 6,}, // 94: 6.670117
{ 0, 0, 11, 5,}, // 95: 6.411955
{ 0, 0, 12, 4,}, // 96: 6.260678
{ 0, 0, 12, 4,}, // 97: 6.010264
{ 0, 0, 13, 3,}, // 98: 5.781699
{ 0, 0, 14, 2,}, // 99: 5.799597
{ 0, 0, 14, 2,}, // 100: 5.442561
{ 0, 0, 16, 0,}, // 101: 3.968404
{ 0, 0, 16, 0,}, // 102: 2.203741
{ 0, 0, 16, 0,}, // 103: 1.507881
{ 0, 0, 16, 0,}, // 104: 1.464000
{ 4, 0, 12, 0,}, // 105: 1.887077
{ 5, 0, 11, 0,}, // 106: 1.794059
{ 7, 0, 9, 0,}, // 107: 1.640110
{ 8, 0, 8, 0,}, // 108: 1.576902
{ 10, 0, 6, 0,}, // 109: 1.502109
{ 11, 0, 5, 0,}, // 110: 1.362379
{ 12, 0, 4, 0,}, // 111: 1.267085
{ 0, 0, 0, 16,}, // 112: 20.091642
{ 0, 0, 5, 11,}, // 113: 19.273121
{ 0, 0, 7, 9,}, // 114: 17.448635
{ 0, 0, 8, 8,}, // 115: 15.698641
{ 0, 0, 10, 6,}, // 116: 13.942268
{ 0, 0, 11, 5,}, // 117: 12.372309
{ 0, 0, 12, 4,}, // 118: 11.001409
{ 0, 0, 13, 3,}, // 119: 10.120058
{ 0, 0, 16, 0,}, // 120: 6.951893
{ 0, 0, 16, 0,}, // 121: 4.175305
{ 0, 0, 16, 0,}, // 122: 2.883262
{ 5, 0, 11, 0,}, // 123: 3.016212
{ 8, 0, 8, 0,}, // 124: 2.418097
{ 11, 0, 5, 0,}, // 125: 1.931664
{ 13, 0, 3, 0,}, // 126: 1.434527
{ 16, 0, 0, 0,}, // 127: 1.079862
{ 0, 0, 7, 9,}, // 128: 4.154392
{ 0, 0, 8, 8,}, // 129: 4.105173
{ 0, 0, 9, 7,}, // 130: 4.366721
{ 0, 0, 10, 6,}, // 131: 4.714817
{ 0, 0, 11, 5,}, // 132: 5.121023
{ 0, 0, 11, 5,}, // 133: 5.244284
{ 0, 0, 12, 4,}, // 134: 4.952907
{ 0, 4, 9, 3,}, // 135: 5.310151
{ 0, 0, 13, 3,}, // 136: 5.506182
{ 0, 4, 10, 2,}, // 137: 5.181949
{ 0, 7, 9, 0,}, // 138: 4.343816
{ 0, 6, 10, 0,}, // 139: 2.415480
{ 0, 5, 11, 0,}, // 140: 1.340145
{ 0, 4, 12, 0,}, // 141: 1.577034
{ 4, 4, 8, 0,}, // 142: 1.969682
{ 5, 4, 7, 0,}, // 143: 1.937322
{ 0, 0, 11, 5,}, // 144: 5.262824
{ 0, 0, 12, 4,}, // 145: 5.592458
{ 0, 5, 9, 2,}, // 146: 5.467087
{ 0, 8, 8, 0,}, // 147: 3.997732
{ 0, 5, 11, 0,}, // 148: 0.952665
{ 3, 5, 8, 0,}, // 149: 1.706804
{ 6, 4, 6, 0,}, // 150: 1.678052
{ 8, 3, 5, 0,}, // 151: 1.846558
{ 0, 0, 12, 4,}, // 152: 5.615221
{ 0, 0, 14, 2,}, // 153: 5.153351
{ 0, 0, 16, 0,}, // 154: 4.749968
{ 0, 0, 16, 0,}, // 155: 2.505809
{ 0, 0, 16, 0,}, // 156: 0.000000
{ 3, 0, 13, 0,}, // 157: 1.296586
{ 5, 0, 11, 0,}, // 158: 1.254987
{ 7, 0, 9, 0,}, // 159: 1.245686
{ 0, 0, 0, 16,}, // 160: 10.746456
{ 0, 0, 0, 16,}, // 161: 8.065981
{ 0, 5, 0, 11,}, // 162: 8.528467
{ 0, 9, 0, 7,}, // 163: 7.230309
{ 0, 12, 0, 4,}, // 164: 6.116160
{ 0, 14, 0, 2,}, // 165: 4.923770
{ 0, 16, 0, 0,}, // 166: 0.000000
{ 5, 11, 0, 0,}, // 167: 2.242939
{ 0, 0, 0, 16,}, // 168: 14.476759
{ 0, 0, 0, 16,}, // 169: 3.505981
{ 0, 2, 0, 14,}, // 170: 6.772447
{ 0, 5, 0, 11,}, // 171: 9.576896
{ 0, 7, 0, 9,}, // 172: 12.518097
{ 0, 9, 0, 7,}, // 173: 14.728203
{ 0, 11, 0, 5,}, // 174: 16.920847
{ 0, 16, 0, 0,}, // 175: 18.232542
{ 0, 16, 0, 0,}, // 176: 18.019087
{ 0, 16, 0, 0,}, // 177: 15.178550
{ 0, 16, 0, 0,}, // 178: 13.160194
{ 0, 16, 0, 0,}, // 179: 11.254657
{ 0, 16, 0, 0,}, // 180: 9.486621
{ 0, 16, 0, 0,}, // 181: 7.896854
{ 0, 16, 0, 0,}, // 182: 6.553573
{ 0, 16, 0, 0,}, // 183: 5.563946
{ 0, 16, 0, 0,}, // 184: 5.058115
{ 4, 12, 0, 0,}, // 185: 5.219287
{ 5, 11, 0, 0,}, // 186: 4.635747
{ 7, 9, 0, 0,}, // 187: 4.094779
{ 8, 8, 0, 0,}, // 188: 3.628493
{ 10, 6, 0, 0,}, // 189: 3.176202
{ 11, 5, 0, 0,}, // 190: 2.760862
{ 12, 4, 0, 0,}, // 191: 2.401772
{ 0, 0, 0, 16,}, // 192: 9.251770
{ 0, 0, 0, 16,}, // 193: 13.106921
{ 0, 0, 6, 10,}, // 194: 14.527426
{ 0, 0, 9, 7,}, // 195: 15.690427
{ 0, 0, 12, 4,}, // 196: 16.970579
{ 0, 0, 16, 0,}, // 197: 15.618019
{ 0, 0, 16, 0,}, // 198: 15.476497
{ 0, 0, 16, 0,}, // 199: 16.400719
{ 0, 0, 16, 0,}, // 200: 17.100441
{ 16, 0, 0, 0,}, // 201: 14.495218
{ 16, 0, 0, 0,}, // 202: 12.122077
{ 16, 0, 0, 0,}, // 203: 9.911701
{ 16, 0, 0, 0,}, // 204: 7.872527
{ 16, 0, 0, 0,}, // 205: 6.014748
{ 16, 0, 0, 0,}, // 206: 4.351084
{ 16, 0, 0, 0,}, // 207: 2.898067
{ 0, 0, 0, 16,}, // 208: 14.476759
{ 0, 0, 0, 16,}, // 209: 6.868338
{ 0, 0, 0, 16,}, // 210: 0.000000
{ 0, 0, 0, 16,}, // 211: 5.525746
{ 0, 4, 0, 12,}, // 212: 8.807407
{ 0, 5, 0, 11,}, // 213: 10.780784
{ 0, 7, 0, 9,}, // 214: 12.732467
{ 0, 8, 0, 8,}, // 215: 14.181246
{ 0, 9, 0, 7,}, // 216: 13.294175
{ 0, 10, 0, 6,}, // 217: 12.536940
{ 0, 11, 0, 5,}, // 218: 11.436922
{ 0, 12, 0, 4,}, // 219: 10.930580
{ 0, 13, 0, 3,}, // 220: 9.967556
{ 0, 13, 0, 3,}, // 221: 9.411467
{ 0, 16, 0, 0,}, // 222: 7.069834
{ 0, 16, 0, 0,}, // 223: 5.629796
{ 0, 0, 0, 16,}, // 224: 14.476759
{ 0, 0, 0, 16,}, // 225: 11.971094
{ 0, 0, 0, 16,}, // 226: 10.730701
{ 0, 0, 0, 16,}, // 227: 10.452529
{ 0, 0, 0, 16,}, // 228: 10.884886
{ 0, 0, 0, 16,}, // 229: 11.651694
{ 0, 0, 0, 16,}, // 230: 12.406713
{ 0, 0, 0, 16,}, // 231: 12.814651
{ 0, 16, 0, 0,}, // 232: 4.273082
{ 0, 16, 0, 0,}, // 233: 3.051739
{ 0, 16, 0, 0,}, // 234: 2.296259
{ 0, 16, 0, 0,}, // 235: 3.496503
{ 6, 4, 6, 0,}, // 236: 1.800300
{ 9, 4, 3, 0,}, // 237: 1.978669
{ 12, 4, 0, 0,}, // 238: 1.792487
{ 13, 3, 0, 0,}, // 239: 1.455034
{ 16, 0, 0, 0,}, // 240: 2.898067
{ 16, 0, 0, 0,}, // 241: 2.257339
{ 16, 0, 0, 0,}, // 242: 1.678598
{ 16, 0, 0, 0,}, // 243: 1.166648
{ 16, 0, 0, 0,}, // 244: 0.727934
{ 16, 0, 0, 0,}, // 245: 0.371833
{ 16, 0, 0, 0,}, // 246: 0.114238
{ 16, 0, 0, 0,}, // 247: 0.000000
{ 0, 6, 0, 10,}, // 248: 11.794470
{ 0, 0, 0, 16,}, // 249: 8.021592
{ 0, 6, 0, 10,}, // 250: 15.643616
{ 0, 10, 0, 6,}, // 251: 21.457966
{ 0, 16, 0, 0,}, // 252: 14.944967
{ 0, 16, 0, 0,}, // 253: 8.013844
{ 7, 9, 0, 0,}, // 254: 5.483591
{ 0, 12, 0, 4,}, // 255: 5.592070
};

static unsigned char mix_weights_hirez[256][2] = {
{ 16, 0,}, // 0: 0.000000
{ 16, 0,}, // 1: 3.162877
{ 16, 0,}, // 2: 1.972921
{ 13, 3,}, // 3: 3.023968
{ 0, 16,}, // 4: 0.000000
{ 15, 1,}, // 5: 2.532063
{ 16, 0,}, // 6: 2.244976
{ 16, 0,}, // 7: 1.103170
{ 16, 0,}, // 8: 0.612999
{ 14, 2,}, // 9: 2.950513
{ 15, 1,}, // 10: 3.628078
{ 15, 1,}, // 11: 2.962386
{ 16, 0,}, // 12: 2.260143
{ 13, 3,}, // 13: 4.352364
{ 14, 2,}, // 14: 3.923292
{ 14, 2,}, // 15: 3.834948
{ 4, 12,}, // 16: 9.109753
{ 5, 11,}, // 17: 9.462293
{ 5, 11,}, // 18: 9.766668
{ 6, 10,}, // 19: 9.968747
{ 7, 9,}, // 20: 10.500564
{ 7, 9,}, // 21: 10.161597
{ 8, 8,}, // 22: 10.842706
{ 8, 8,}, // 23: 10.716986
{ 9, 7,}, // 24: 10.545033
{ 9, 7,}, // 25: 10.821122
{ 10, 6,}, // 26: 10.660322
{ 10, 6,}, // 27: 10.538860
{ 11, 5,}, // 28: 10.584070
{ 11, 5,}, // 29: 10.591230
{ 11, 5,}, // 30: 10.575039
{ 12, 4,}, // 31: 10.432224
{ 12, 4,}, // 32: 10.136872
{ 12, 4,}, // 33: 10.134342
{ 13, 3,}, // 34: 9.705795
{ 13, 3,}, // 35: 9.699158
{ 13, 3,}, // 36: 9.314177
{ 13, 3,}, // 37: 9.354319
{ 14, 2,}, // 38: 8.745334
{ 14, 2,}, // 39: 8.538713
{ 14, 2,}, // 40: 8.107565
{ 14, 2,}, // 41: 8.077693
{ 15, 1,}, // 42: 7.717675
{ 15, 1,}, // 43: 7.339993
{ 15, 1,}, // 44: 6.622275
{ 16, 0,}, // 45: 6.227608
{ 16, 0,}, // 46: 5.420531
{ 16, 0,}, // 47: 5.026935
{ 1, 15,}, // 48: 4.700754
{ 2, 14,}, // 49: 5.661571
{ 2, 14,}, // 50: 6.486069
{ 3, 13,}, // 51: 7.524214
{ 3, 13,}, // 52: 7.910698
{ 3, 13,}, // 53: 8.952188
{ 4, 12,}, // 54: 9.728190
{ 4, 12,}, // 55: 10.216728
{ 5, 11,}, // 56: 11.440166
{ 5, 11,}, // 57: 11.134138
{ 6, 10,}, // 58: 11.076385
{ 6, 10,}, // 59: 10.948090
{ 7, 9,}, // 60: 10.764825
{ 7, 9,}, // 61: 10.778378
{ 8, 8,}, // 62: 10.479200
{ 8, 8,}, // 63: 10.468348
{ 9, 7,}, // 64: 9.695905
{ 9, 7,}, // 65: 9.070922
{ 10, 6,}, // 66: 8.700906
{ 10, 6,}, // 67: 8.142102
{ 10, 6,}, // 68: 8.179445
{ 11, 5,}, // 69: 7.165587
{ 11, 5,}, // 70: 7.101255
{ 12, 4,}, // 71: 6.687458
{ 12, 4,}, // 72: 6.140609
{ 13, 3,}, // 73: 6.086236
{ 13, 3,}, // 74: 4.998869
{ 13, 3,}, // 75: 4.571978
{ 14, 2,}, // 76: 4.566504
{ 14, 2,}, // 77: 3.736165
{ 14, 2,}, // 78: 4.061320
{ 15, 1,}, // 79: 3.359486
{ 1, 15,}, // 80: 3.154431
{ 2, 14,}, // 81: 2.270905
{ 3, 13,}, // 82: 3.742738
{ 3, 13,}, // 83: 2.498833
{ 3, 13,}, // 84: 3.948201
{ 4, 12,}, // 85: 2.407922
{ 4, 12,}, // 86: 3.616925
{ 5, 11,}, // 87: 2.033330
{ 6, 10,}, // 88: 3.559891
{ 6, 10,}, // 89: 2.388310
{ 6, 10,}, // 90: 3.910947
{ 7, 9,}, // 91: 2.900738
{ 7, 9,}, // 92: 3.349602
{ 8, 8,}, // 93: 2.373181
{ 8, 8,}, // 94: 2.711676
{ 9, 7,}, // 95: 3.064542
{ 9, 7,}, // 96: 3.060956
{ 10, 6,}, // 97: 3.840060
{ 10, 6,}, // 98: 2.226325
{ 11, 5,}, // 99: 3.688077
{ 11, 5,}, // 100: 2.681853
{ 11, 5,}, // 101: 3.276316
{ 12, 4,}, // 102: 2.752042
{ 12, 4,}, // 103: 2.174505
{ 13, 3,}, // 104: 3.930553
{ 13, 3,}, // 105: 2.131779
{ 13, 3,}, // 106: 2.725150
{ 14, 2,}, // 107: 3.527215
{ 14, 2,}, // 108: 2.698863
{ 14, 2,}, // 109: 2.882897
{ 15, 1,}, // 110: 3.554518
{ 15, 1,}, // 111: 2.826927
{ 4, 12,}, // 112: 14.138620
{ 5, 11,}, // 113: 13.178967
{ 6, 10,}, // 114: 12.242190
{ 7, 9,}, // 115: 11.329672
{ 8, 8,}, // 116: 10.247314
{ 9, 7,}, // 117: 9.438586
{ 10, 6,}, // 118: 8.713874
{ 10, 6,}, // 119: 8.222451
{ 11, 5,}, // 120: 7.135536
{ 12, 4,}, // 121: 6.360008
{ 13, 3,}, // 122: 5.951371
{ 13, 3,}, // 123: 5.143507
{ 14, 2,}, // 124: 4.200910
{ 15, 1,}, // 125: 4.289530
{ 15, 1,}, // 126: 2.953075
{ 16, 0,}, // 127: 2.164012
{ 6, 10,}, // 128: 5.623372
{ 7, 9,}, // 129: 5.132666
{ 8, 8,}, // 130: 5.511966
{ 8, 8,}, // 131: 5.082297
{ 9, 7,}, // 132: 5.237485
{ 9, 7,}, // 133: 5.121642
{ 9, 7,}, // 134: 5.493481
{ 10, 6,}, // 135: 4.845304
{ 10, 6,}, // 136: 5.292644
{ 11, 5,}, // 137: 4.566669
{ 11, 5,}, // 138: 4.724578
{ 12, 4,}, // 139: 4.687091
{ 12, 4,}, // 140: 4.157088
{ 13, 3,}, // 141: 4.846282
{ 13, 3,}, // 142: 3.897707
{ 13, 3,}, // 143: 3.956564
{ 9, 7,}, // 144: 5.641809
{ 10, 6,}, // 145: 5.458966
{ 11, 5,}, // 146: 5.537491
{ 11, 5,}, // 147: 5.270129
{ 12, 4,}, // 148: 4.649210
{ 13, 3,}, // 149: 4.487115
{ 13, 3,}, // 150: 4.657611
{ 14, 2,}, // 151: 3.779618
{ 10, 6,}, // 152: 3.635238
{ 11, 5,}, // 153: 4.154866
{ 11, 5,}, // 154: 3.430387
{ 12, 4,}, // 155: 3.887741
{ 12, 4,}, // 156: 3.737777
{ 13, 3,}, // 157: 3.395479
{ 13, 3,}, // 158: 3.548160
{ 14, 2,}, // 159: 3.637814
{ 0, 16,}, // 160: 10.628353
{ 4, 12,}, // 161: 11.262287
{ 6, 10,}, // 162: 10.775217
{ 8, 8,}, // 163: 10.476766
{ 9, 7,}, // 164: 9.909468
{ 11, 5,}, // 165: 9.357160
{ 12, 4,}, // 166: 8.779848
{ 13, 3,}, // 167: 8.150807
{ 0, 16,}, // 168: 0.000000
{ 2, 14,}, // 169: 5.630848
{ 4, 12,}, // 170: 8.818243
{ 5, 11,}, // 171: 11.774660
{ 7, 9,}, // 172: 14.472336
{ 8, 8,}, // 173: 16.744305
{ 9, 7,}, // 174: 19.187151
{ 10, 6,}, // 175: 21.260931
{ 11, 5,}, // 176: 22.539795
{ 12, 4,}, // 177: 20.917423
{ 12, 4,}, // 178: 19.625549
{ 12, 4,}, // 179: 18.424139
{ 12, 4,}, // 180: 17.326004
{ 13, 3,}, // 181: 16.103060
{ 13, 3,}, // 182: 14.913567
{ 13, 3,}, // 183: 13.833478
{ 13, 3,}, // 184: 12.882592
{ 14, 2,}, // 185: 11.307191
{ 14, 2,}, // 186: 10.253874
{ 14, 2,}, // 187: 9.347155
{ 15, 1,}, // 188: 8.555857
{ 15, 1,}, // 189: 7.435950
{ 16, 0,}, // 190: 6.227608
{ 16, 0,}, // 191: 5.026935
{ 2, 14,}, // 192: 4.067422
{ 4, 12,}, // 193: 5.951301
{ 6, 10,}, // 194: 7.883518
{ 7, 9,}, // 195: 9.822075
{ 9, 7,}, // 196: 11.271643
{ 11, 5,}, // 197: 13.057537
{ 12, 4,}, // 198: 14.514785
{ 13, 3,}, // 199: 15.818985
{ 16, 0,}, // 200: 16.481758
{ 16, 0,}, // 201: 14.168860
{ 16, 0,}, // 202: 12.253104
{ 16, 0,}, // 203: 10.404237
{ 16, 0,}, // 204: 8.628445
{ 16, 0,}, // 205: 6.933524
{ 16, 0,}, // 206: 5.329669
{ 16, 0,}, // 207: 3.830918
{ 0, 16,}, // 208: 0.000000
{ 1, 15,}, // 209: 4.941270
{ 2, 14,}, // 210: 7.504269
{ 3, 13,}, // 211: 9.569269
{ 5, 11,}, // 212: 11.725086
{ 5, 11,}, // 213: 13.692756
{ 7, 9,}, // 214: 15.626595
{ 7, 9,}, // 215: 17.146545
{ 8, 8,}, // 216: 16.473553
{ 8, 8,}, // 217: 16.144873
{ 9, 7,}, // 218: 15.162672
{ 10, 6,}, // 219: 14.916658
{ 10, 6,}, // 220: 14.026222
{ 11, 5,}, // 221: 13.782843
{ 11, 5,}, // 222: 12.858162
{ 11, 5,}, // 223: 12.400164
{ 0, 16,}, // 224: 0.000000
{ 0, 16,}, // 225: 3.278798
{ 0, 16,}, // 226: 6.077520
{ 0, 16,}, // 227: 8.711452
{ 0, 16,}, // 228: 11.152089
{ 0, 16,}, // 229: 13.354692
{ 0, 16,}, // 230: 15.234977
{ 0, 16,}, // 231: 16.481758
{ 12, 4,}, // 232: 11.759201
{ 12, 4,}, // 233: 11.289021
{ 13, 3,}, // 234: 10.645083
{ 13, 3,}, // 235: 9.944007
{ 13, 3,}, // 236: 4.505016
{ 14, 2,}, // 237: 3.818308
{ 15, 1,}, // 238: 4.303171
{ 15, 1,}, // 239: 3.484603
{ 16, 0,}, // 240: 3.830918
{ 16, 0,}, // 241: 3.127067
{ 16, 0,}, // 242: 2.458153
{ 16, 0,}, // 243: 1.829062
{ 16, 0,}, // 244: 1.246780
{ 16, 0,}, // 245: 0.722350
{ 16, 0,}, // 246: 0.276893
{ 16, 0,}, // 247: 0.000000
{ 6, 10,}, // 248: 14.617802
{ 3, 13,}, // 249: 13.213470
{ 6, 10,}, // 250: 13.676251
{ 9, 7,}, // 251: 21.175062
{ 11, 5,}, // 252: 16.536200
{ 12, 4,}, // 253: 12.386811
{ 14, 2,}, // 254: 8.435212
{ 10, 6,}, // 255: 7.343525
};

// C2P table for full resolution
// [phase 0..3][color 0..255][pixel 0..7]
static unsigned long c2p_table[4][256][8];

// C2P table for half resolution (2x2 pixels)
// [phase 0..3][color 0..255][pixel 0..3]
static unsigned long c2p_2x_table[4][256][4];

// C2P table for quarter resolution (4x4 pixels)
// [phase 0..3][color 0..255][pixel 0..1]
static unsigned long c2p_4x_table[4][256][2];

static unsigned short convert_channel(unsigned char v) {
    unsigned short r = (v & 0xe0) >> 5; // Bits 7,6,5 shifted to 2,1,0
    r |= (v & 0x10) >> 1; // STe color bit
    return r;
}
static unsigned short stcolor(unsigned char r, unsigned char g, unsigned char b) {
    unsigned short entry = convert_channel(r);
    entry <<= 4;
    entry |= convert_channel(g);
    entry <<= 4;
    entry |= convert_channel(b);
    return entry;
}

void install_palette(const unsigned short *palette) {
    volatile unsigned short *reg = (unsigned short*) 0xff8240;
    for (short n=0; n<16; n++) *reg++ = *palette++;
}

void save_palette(unsigned short *palette) {
    volatile unsigned short *reg = (unsigned short*) 0xff8240;
    for (short n=0; n<16; n++) *palette++ = *reg++;
}

// Find the ST palette color index to fill a pixel with according to given weights.
short bayer4_color(const unsigned char *weights, short numcolors, short phase, short px) {
    static unsigned char bayer[4][4] = {
        {0,  8, 2,10},
        {12, 4,14, 6},
        { 3,11, 1, 9},
        {15, 7,13, 5}
    };

    unsigned char bayer_lwb = 0, bayer_upb = 0;
    short c;
    for (c=0; c<numcolors; c++) {
        bayer_upb += weights[c];
        if (bayer[phase][px%4] >= bayer_lwb && bayer[phase][px%4] < bayer_upb) {
            return c; // Search for color is finished.
        }
        bayer_lwb += weights[c];
    }
    return -1;
}


/// @brief Computes a movep-compatible Bayer-dithered pixel given a set of mixing weights.
/// @param weights An array of mixing weights, each weight corresponding to a palette color. Must sum up to 16.
/// @param phase The vertical phase within the bayer pattern (0..3).
/// @param px The pixel within the group of 8 pixels covered by a movep-DWORD (0..7).
/// @return A DWORD that can be written into an Atari ST lo-res framebuffer using movep.l.
unsigned long bayer4_lorez_pdata(const unsigned char *weights, short phase, short px) {
    short c = bayer4_color(weights, 16, phase, px);
    // Compute a pdata-compatible pixel representation.
    unsigned long pdata = 0;
    if (c & 1) pdata |= 0x01000000;
    if (c & 2) pdata |= 0x00010000;
    if (c & 4) pdata |= 0x00000100;
    if (c & 8) pdata |= 0x00000001;
    return pdata << (7-px);
}

/// @brief Computes a longword containing Bayer-dithered pixel given a set of mixing weights.
/// @param weights An array of mixing weights, each weight corresponding to a palette color. Must sum up to 16.
/// @param phase The vertical phase within the bayer pattern (0..3).
/// @param px The pixel within the group of 16 pixels covered by a longword in midrez (0..15).
/// @return A DWORD that can be written into an Atari ST mid-res framebuffer.
unsigned long bayer4_midrez_pdata(const unsigned char *weights, short phase, short px) {
    short c = bayer4_color(weights, 4, phase, px);
    // Compute a midrez-compatible pixel representation.
    unsigned long data = 0;
    if (c & 1) data |= 0x00010000;
    if (c & 2) data |= 0x00000001;
    return data << (15-px);
}

static void c2p_1x_lorez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]);
static void c2p_1x_midrez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]);
static void c2p_1x_hirez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]);
static void c2p_screen_lorez(unsigned char *out, const unsigned char *in);
static void c2p_screen_midrez(unsigned char *out, const unsigned char *in);
static void c2p_screen_hirez(unsigned char *out, const unsigned char *in);

static void c2p_statusbar_lorez(unsigned char *out, const unsigned char *in, short y_begin, short y_end, short x_begin, short x_end) {
    out += y_begin * 160 + x_begin / 2;
    in += y_begin * 320 + x_begin;
    for (int line = y_begin; line < y_end; line++ ) {
        c2p_1x_lorez(out, in, x_end - x_begin, c2p_table[line&3]);
        out += 160;
        in += 320;
    }
}

static void c2p_statusbar_midrez(unsigned char *out, const unsigned char *in, short y_begin, short y_end, short x_begin, short x_end) {
    out += y_begin * 160 + x_begin / 2;
    in += y_begin * 320 + x_begin;
    for (int line = y_begin; line < y_end; line++ ) {
        c2p_1x_midrez(out, in, x_end - x_begin, c2p_table[line&3]);
        out += 160;
        in += 320;
    }
}

static void c2p_statusbar_hirez(unsigned char *out, const unsigned char *in, short y_begin, short y_end, short x_begin, short x_end) {
    out += y_begin * 160 + x_begin / 4;
    in += y_begin * 320 + x_begin;
    for (int line = y_begin; line < y_end; line++ ) {
        c2p_1x_hirez(out, in, x_end - x_begin, c2p_table[line&1]);
        out += 160;
        in += 320;
    }
}

void init_c2p_table() {
    short res = Getrez();
    if (res == 0) {
        // Low Resolution, 16 colors
        subset = subset_lorez;
        num_colors = 16;
        c2p_screen_drawfunc = c2p_screen_lorez;
        c2p_statusbar_drawfunc = c2p_statusbar_lorez;
        set_doom_palette(W_CacheLumpName("PLAYPAL", PU_CACHE));
        for (int i=0; i<256; i++) {
            unsigned char *weights = mix_weights_lorez[i];
            for (int phase=0; phase<4; phase++) {
                // Fill 1x1 c2p table
                for (int px=0; px<8; px++) {
                    c2p_table[phase][i][px] = bayer4_lorez_pdata(weights, phase, px);
                }
                // Fill 2x2 c2p table
                for (int ipx=0; ipx<4; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=2*ipx; opx<2*ipx+2; opx++) {
                        ipx_pdata |= bayer4_lorez_pdata(weights, phase, opx);
                    }
                    c2p_2x_table[phase][i][ipx] = ipx_pdata;
                }
                // Fill 4x4 c2p table
                for (int ipx=0; ipx<2; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=4*ipx; opx<4*ipx+4; opx++) {
                        ipx_pdata |= bayer4_lorez_pdata(weights, phase, opx);
                    }
                    c2p_4x_table[phase][i][ipx] = ipx_pdata;
                }
            }
        }
    } else if (res == 1) {
        // Medium resolution, 4 colors
        subset = subset_midrez;
        num_colors = 4;
        c2p_screen_drawfunc = c2p_screen_midrez;
        c2p_statusbar_drawfunc = c2p_statusbar_midrez;
        set_doom_palette(W_CacheLumpName("PLAYPAL", PU_CACHE));
        for (int i=0; i<256; i++) {
            unsigned char *weights = mix_weights_midrez[i];
            for (int phase=0; phase<4; phase++) {
                // Fill 1x1 c2p table
                for (int ipx=0; ipx<8; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=2*ipx; opx<2*ipx+2; opx++) {
                        ipx_pdata |= bayer4_midrez_pdata(weights, phase, opx);
                    }
                    c2p_table[phase][i][ipx] = ipx_pdata;
                }
                // Fill 2x2 c2p table
                for (int ipx=0; ipx<4; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=4*ipx; opx<4*ipx+4; opx++) {
                        ipx_pdata |= bayer4_midrez_pdata(weights, phase, opx);
                    }
                    c2p_2x_table[phase][i][ipx] = ipx_pdata;
                }
                // Fill 4x4 c2p table
                for (int ipx=0; ipx<2; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=8*ipx; opx<8*ipx+8; opx++) {
                        ipx_pdata |= bayer4_midrez_pdata(weights, phase, opx);
                    }
                    c2p_4x_table[phase][i][ipx] = ipx_pdata;
                }
            }
        }
    } else if (res == 2) {
        // High resolution, 2 colors
        subset = subset_hirez;
        num_colors = 2;
        c2p_screen_drawfunc = c2p_screen_hirez;
        c2p_statusbar_drawfunc = c2p_statusbar_hirez;
        for (int i=0; i<256; i++) {
            unsigned char *weights = mix_weights_hirez[i];
            for (int phase=0; phase<2; phase++) {
                // Fill 1x1 c2p table
                for (int ipx=0; ipx<8; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=2*ipx; opx<2*ipx+2; opx++) {
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase, opx) << (31 - opx);
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase+1, opx) << (15 - opx);
                    }
                    c2p_table[phase][i][ipx] = ipx_pdata;
                }
                // Fill 2x2 c2p table
                for (int ipx=0; ipx<4; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=4*ipx; opx<4*ipx+4; opx++) {
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase, opx) << (31 - opx);
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase+1, opx) << (15 - opx);
                    }
                    c2p_2x_table[phase][i][ipx] = ipx_pdata;
                }
                // Fill 4x4 c2p table
                for (int ipx=0; ipx<2; ipx++) {
                    unsigned long ipx_pdata = 0;
                    for (int opx=8*ipx; opx<8*ipx+8; opx++) {
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase, opx) << (31 - opx);
                        ipx_pdata |= bayer4_color(weights, 2, 2*phase+1, opx) << (15 - opx);
                    }
                    c2p_4x_table[phase][i][ipx] = ipx_pdata;
                }
            }
        }
    } else {
        I_Error("Unsupported resolution %d\n", res);
    }
}

static void c2p_1x_lorez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]) {
    if (pixels < 16) return;
    unsigned short groups = pixels / 16 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned long mask = 0x00ff00ff<<5; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read eight consecutive pixels from buffer into two 32 bit registers
        "movem.l    (%[in])+, %%d0-%%d1             \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "lsr.l      #3,%%d0                         \n\t"
        "and.l      %[mask],%%d0                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d0.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d0                            \n\t"
        "or.l       (%[table],%%d0.w), %[pdata]     \n\t"

        // Prepare pixels 5,7
        "move.l     %%d1,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 7
        "or.l       28(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 5
        "swap       %%d2                            \n\t"
        "or.l       20(%[table],%%d2.w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "lsr.l      #3,%%d1                         \n\t"
        "and.l      %[mask],%%d1                    \n\t"

        // Pixel 6
        "or.l       24(%[table],%%d1.w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %%d1                            \n\t"
        "or.l       16(%[table],%%d1.w), %[pdata]   \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 0(%[out])             \n\t"

        // Read another eight consecutive pixels from buffer into two 32 bit registers
        "movem.l    (%[in])+, %%d0-%%d1             \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "lsr.l      #3,%%d0                         \n\t"
        "and.l      %[mask],%%d0                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d0.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d0                            \n\t"
        "or.l       (%[table],%%d0.w), %[pdata]     \n\t"

        // Prepare pixels 5,7
        "move.l     %%d1,%%d2                       \n\t"
        "lsl.l      #5,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 7
        "or.l       28(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 5
        "swap       %%d2                            \n\t"
        "or.l       20(%[table],%%d2.w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "lsr.l      #3,%%d1                         \n\t"
        "and.l      %[mask],%%d1                    \n\t"

        // Pixel 6
        "or.l       24(%[table],%%d1.w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %%d1                            \n\t"
        "or.l       16(%[table],%%d1.w), %[pdata]   \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 1(%[out])             \n\t"
        
        // Advance out address by 16 pixels (8 bytes) and loop
        "lea        8(%[out]), %[out]               \n\t"
        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d1", "d2", "memory"
    );
}

static void c2p_1x_midrez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]) {
    if (pixels < 8) return;
    pixels -= pixels % 8; 
    while (pixels != 0) {
		register unsigned long pdata = 0;
        for(int i=0; i<8; i++) {
            pdata |= table[*in++][i];
        }
        *(unsigned long*)out = pdata;
		pixels -= 8;
		out += 4;
	}
}

static void c2p_1x_hirez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][8]) {
    if (pixels < 16) return;
    pixels -= pixels % 16; 
    while (pixels != 0) {
		register unsigned long pdata = 0;
        for(int i=0; i<8; i++) {
            pdata |= table[*in++][i];
        }
        *(unsigned short*)(out + 80) = pdata;
        *(unsigned short*)out = pdata >> 16;
		pixels -= 8;
		out += 2;
	}
}


static void c2p_2x_lorez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][4]) {
    if (pixels < 8) return;
    short groups = pixels / 8 - 1;
    unsigned long pdata; // 32 bits of planar pixel data
    unsigned long p0, p1; // Helper variables for holding pixel data read from input
    unsigned long mask = 0x00ff00ff<<4; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read four consecutive pixels from buffer into a 32 bit register
        "move.l     (%[in])+,%[p0]                  \n\t"

        // Prepare pixels 1, 3
        "move.l     %[p0],%[p1]                     \n\t"
        "lsl.l      #4,%[p1]                        \n\t"
        "and.l      %[mask],%[p1]                   \n\t"

        // Pixel 3
        "move.l     12(%[table],%[p1].w), %[pdata]  \n\t"

        // Pixel 1
        "swap       %[p1]                           \n\t"
        "or.l       4(%[table],%[p1].w), %[pdata]   \n\t"

        // Prepare pixels 0, 2
        "lsr.l      #4,%[p0]                        \n\t"
        "and.l      %[mask],%[p0]                   \n\t"

        // Pixel 2
        "or.l       8(%[table],%[p0].w), %[pdata]   \n\t"

        // Pixel 0
        "swap       %[p0]                           \n\t"
        "or.l       (%[table],%[p0].w), %[pdata]    \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 0(%[out])             \n\t"

        // Read four consecutive pixels from buffer into a 32 bit register
        "move.l     (%[in])+,%[p0]                  \n\t"

        // Prepare pixels 5,7
        "move.l     %[p0],%[p1]                     \n\t"
        "lsl.l      #4,%[p1]                        \n\t"
        "and.l      %[mask],%[p1]                   \n\t"

        // Pixel 7
        "move.l     12(%[table],%[p1].w), %[pdata]  \n\t"

        // Pixel 5
        "swap       %[p1]                           \n\t"
        "or.l       4(%[table],%[p1].w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "lsr.l      #4,%[p0]                        \n\t"
        "and.l      %[mask],%[p0]                   \n\t"

        // Pixel 6
        "or.l       8(%[table],%[p0].w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %[p0]                           \n\t"
        "or.l       (%[table],%[p0].w), %[pdata]    \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata], 1(%[out])             \n\t"

        // Advance out address by 16 pixels (8 bytes) and loop
        "lea        8(%[out]), %[out]               \n\t"
        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+&a" (out)
        , [in] "+&a" (in)
        , [pdata] "=&d" (pdata)
        , [groups] "+&d" (groups)
        , [p0] "=&d" (p0)
        , [p1] "=&d" (p1)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "memory", "cc"
    );
}

static void c2p_2x_midrez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][4]) {
    if (pixels < 8) return;
    short groups = pixels / 8 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned long mask = 0x00ff00ff<<4; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read eight consecutive pixels from buffer into two 32 bit registers
        "movem.l    (%[in])+, %%d0-%%d1             \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #4,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "lsr.l      #4,%%d0                         \n\t"
        "and.l      %[mask],%%d0                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d0.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d0                            \n\t"
        "or.l       (%[table],%%d0.w), %[pdata]     \n\t"

        // Write these pixels into ST screen buffer
        "move.l    %[pdata], (%[out])+              \n\t"

        // Prepare pixels 5,7
        "move.l     %%d1,%%d2                       \n\t"
        "lsl.l      #4,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 7
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 5
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]   \n\t"

        // Prepare pixels 4, 6
        "lsr.l      #4,%%d1                         \n\t"
        "and.l      %[mask],%%d1                    \n\t"

        // Pixel 6
        "or.l       8(%[table],%%d1.w), %[pdata]   \n\t"

        // Pixel 4
        "swap       %%d1                            \n\t"
        "or.l       (%[table],%%d1.w), %[pdata]     \n\t"

        // Write these pixels into ST screen buffer
        "move.l     %[pdata], (%[out])+             \n\t"

        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d1", "d2", "memory"
    );
}

static void c2p_2x_hirez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][4]) {
    if (pixels < 4) return;
    short groups = pixels / 4 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned long mask = 0x00ff00ff<<4; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read four consecutive pixels from buffer
        "move.l     (%[in])+, %%d0                  \n\t"

        // Prepare pixels 1, 3
        "move.l     %%d0,%%d2                       \n\t"
        "lsl.l      #4,%%d2                         \n\t"
        "and.l      %[mask],%%d2                    \n\t"

        // Pixel 3
        "move.l     12(%[table],%%d2.w), %[pdata]   \n\t"

        // Pixel 1
        "swap       %%d2                            \n\t"
        "or.l       4(%[table],%%d2.w), %[pdata]    \n\t"

        // Prepare pixels 0, 2
        "lsr.l      #4,%%d0                         \n\t"
        "and.l      %[mask],%%d0                    \n\t"

        // Pixel 2
        "or.l       8(%[table],%%d0.w), %[pdata]    \n\t"

        // Pixel 0
        "swap       %%d0                            \n\t"
        "or.l       (%[table],%%d0.w), %[pdata]     \n\t"

        // Write these pixels into ST screen buffer
        // Hi-rez specialty: write into two consecutive lines
        "move.w     %[pdata], 80(%[out])           \n\t"
        "swap       %[pdata]                        \n\t"
        "move.w     %[pdata], (%[out])+             \n\t"

        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d2", "memory"
    );
}

static void c2p_4x_lorez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][2]) {
    if (pixels < 4) return;
    short groups = pixels / 4 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned long mask = 0xff00ff<<3; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read four consecutive pixels from buffer into one 32 register
        "move.l     (%[in])+, %%d0                  \n\t"
        "move.l     %%d0,%%d1                       \n\t"

        // Prepare d0 for reading pixels 0 and 2
        "lsr.l      #5,%%d0                         \n\t"
        "and.l      %[mask],%%d0                    \n\t"

        // Prepare d1 for reading pixels 1 and 3
        "lsl.l      #3,%%d1                         \n\t"
        "and.l      %[mask],%%d1                    \n\t"

        // Pixel 2
        "move.l     0(%[table],%%d0.w),%[pdata]     \n\t"

        // Pixel 3
        "or.l       4(%[table],%%d1.w),%[pdata]     \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata],1(%[out])              \n\t"
        "movep.l    %[pdata],321(%[out])            \n\t"

        // Move pixels 0 and 1 into lower word positions of d0 and d1
        "swap       %%d0                            \n\t"
        "swap       %%d1                            \n\t"

        // Pixel 0
        "move.l     (%[table],%%d0.w),%[pdata]      \n\t"

        // Pixel 1
        "or.l       4(%[table],%%d1.w),%[pdata]     \n\t"

        // Write these pixels into ST screen buffer
        "movep.l    %[pdata],0(%[out])              \n\t"
        "movep.l    %[pdata],320(%[out])            \n\t"

        // Advance out address by 16 pixels (8 bytes) and loop
        "lea        8(%[out]), %[out]               \n\t"
        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d1", "d2", "memory"
    );
}

static void c2p_4x_midrez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][2]) {
    if (pixels < 4) return;
    short groups = pixels / 4 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned short mask = 0x00ff<<3; // Mask for isolating table indices (after shifting)
    unsigned char *out2 = out + 320;
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read four consecutive pixels from buffer into two 16 bit registers
        "movem.w    (%[in])+, %%d0-%%d1             \n\t"

        // Pixel 0
        "move.w     %%d0,%%d2                       \n\t"
        "lsr.w      #5,%%d2                         \n\t"
        "and.w      %[mask],%%d2                    \n\t"
        "move.l     (%[table],%%d2.w), %[pdata]     \n\t"

        // Pixel 1
        "lsl.w      #3,%%d0                         \n\t"
        "and.w      %[mask],%%d0                    \n\t"
        "or.l       4(%[table],%%d0.w), %[pdata]    \n\t"

        // Write these pixels into ST screen buffer
        "move.l     %[pdata], (%[out])+             \n\t"
        "move.l     %[pdata], (%[out2])+            \n\t"

        // Pixel 2
        "move.w     %%d1,%%d2                       \n\t"
        "lsr.w      #5,%%d2                         \n\t"
        "and.w      %[mask],%%d2                    \n\t"
        "move.l     0(%[table],%%d2.w), %[pdata]    \n\t"

        // Pixel 3
        "lsl.w      #3,%%d1                         \n\t"
        "and.w      %[mask],%%d1                    \n\t"
        "or.l       4(%[table],%%d1.w), %[pdata]    \n\t"

        // Write these pixels into ST screen buffer
        "move.l     %[pdata], (%[out])+             \n\t"
        "move.l     %[pdata], (%[out2])+            \n\t"

        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+a" (out)
        , [out2] "+a" (out2)
        , [in] "+a" (in)
        , [pdata] "+d" (pdata)
        , [groups] "+d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d1", "d2", "memory"
    );
}


static void c2p_4x_hirez(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned long table[][2]) {
    if (pixels < 2) return;
    short groups = pixels / 2 - 1;
    unsigned long pdata = 0; // 32 bits of planar pixel data
    unsigned short mask = 0x00ff<<3; // Mask for isolating table indices (after shifting)
    asm volatile (
        // Beginning of dbra loop
        "0:                                         \n\t"

        // Read two consecutive pixels from buffer into a 16 bit register
        "move.w     (%[in])+, %%d0                  \n\t"

        // Pixel 0
        "move.w     %%d0,%%d2                       \n\t"
        "lsr.w      #5,%%d2                         \n\t"
        "and.w      %[mask],%%d2                    \n\t"
        "move.l     (%[table],%%d2.w), %[pdata]     \n\t"

        // Pixel 1
        "lsl.w      #3,%%d0                         \n\t"
        "and.w      %[mask],%%d0                    \n\t"
        "or.l       4(%[table],%%d0.w), %[pdata]    \n\t"

        // Write these pixels into ST screen buffer
        "move.w     %[pdata], 80(%[out])            \n\t"
        "move.w     %[pdata], 400(%[out])           \n\t"
        "swap       %[pdata]                        \n\t"
        "move.w     %[pdata], 320(%[out])           \n\t"
        "move.w     %[pdata], (%[out])+             \n\t"

        "dbra.w     %[groups],0b                    \n\t"

        // Outputs
        : [out] "+&a" (out)
        , [in] "+&a" (in)
        , [pdata] "+&d" (pdata)
        , [groups] "+&d" (groups)
        
        // Inputs
        : [table] "a" (table)
        , [mask] "d" (mask)
        
        // Clobbers
        : "d0", "d2", "memory"
    );
}

void set_doom_palette(const unsigned char *colors) {
    unsigned short stpalette[16];
    for (int i=0; i<16; i++) {
        const unsigned char *c = &colors[3*subset[i]];
        stpalette[i] = stcolor(c[0], c[1], c[2]);
    }
    install_palette(stpalette);
}

void draw_palette_table(unsigned char *st_screen) {
    short res = Getrez();
    unsigned char buf[128+16];
	unsigned char c = 0;
	for (int y=0; y<128; y+=8) {
		for (int x=0; x<128; x+=8) {
			for (int i=0; i<8; i++) buf[x+i] = c;
            for (int i=0; i<16; i++) {
                if (c == subset[i]) {
                    buf[x] = 4;
                    buf[x+7] = 0;
                }
            }
			c++;
		}
        for (int x=128; x<128+8; x++) buf[x] = 0;
        for (int x=128+8; x<128+16; x++) buf[x] = subset[y/8];
        if (res == 0) {
		    for (int i=0; i<8; i++) c2p_1x_lorez(st_screen + 160*(32+y+i), buf, 128+16, c2p_table[i%4]);
        } else if (res == 1) {
		    for (int i=0; i<8; i++) c2p_1x_midrez(st_screen + 160*(32+y+i), buf, 128+16, c2p_table[i%4]);
        } else if (res == 2) {
		    for (int i=0; i<8; i++) c2p_1x_hirez(st_screen + 160*(32+y+i), buf, 128+16, c2p_table[i%2]);
        }
	}
}

extern boolean inhelpscreens;
extern boolean menuactive;
extern boolean automapactive;
extern gamestate_t gamestate;

static void c2p_screen_lorez(unsigned char *out, const unsigned char *in) {
    boolean zoom_allowed = gamestate == GS_LEVEL
        && !menuactive && !inhelpscreens && !automapactive;
    short splitline = !zoom_allowed || viewheight == SCREENHEIGHT ? SCREENHEIGHT : SCREENHEIGHT - 32;
    if (!zoom_allowed || viewwidth > SCREENWIDTH/2) {
        for (short line = 0; line < splitline; line++ ) {
            c2p_1x_lorez(out + 160*line, in + 320*line, 320, c2p_table[line&3]);
        }
    } else if(viewwidth > SCREENWIDTH/4) {
        // 2x zoom
        for (short line = 0; line < splitline; line++ ) {
            c2p_2x_lorez(out + 160*line, in + SCREENWIDTH*(42 + line/2) + 80, 160, c2p_2x_table[line&3]);
        }
    } else {
        // 4x zoom
        for (short line = 0; line < splitline; line++ ) {
            short phase = line & 3;
            if (phase < 2) {
                c2p_4x_lorez(out + 160*line, in + SCREENWIDTH*(63 + line/4) + 120, 80, c2p_4x_table[phase]);
            }
        }
    }
}

static void c2p_screen_midrez(unsigned char *out, const unsigned char *in) {
    boolean zoom_allowed = gamestate == GS_LEVEL
        && !menuactive && !inhelpscreens && !automapactive;
    short splitline = !zoom_allowed || viewheight == SCREENHEIGHT ? SCREENHEIGHT : SCREENHEIGHT - 32;
    if (!zoom_allowed || viewwidth > SCREENWIDTH/2) {
        for (short line = 0; line < splitline; line++ ) {
            c2p_1x_midrez(out + 160*line, in + 320*line, 320, c2p_table[line&3]);
        }
    } else if(viewwidth > SCREENWIDTH/4) {
        // 2x zoom
        for (short line = 0; line < splitline; line++ ) {
            c2p_2x_midrez(out + 160*line, in + SCREENWIDTH*(42 + line/2) + 80, 160, c2p_2x_table[line&3]);
        }
    } else {
        // 4x zoom
        for (short line = 0; line < splitline; line++ ) {
            short phase = line & 3;
            if (phase < 2) {
                c2p_4x_midrez(out + 160*line, in + SCREENWIDTH*(63 + line/4) + 120, 80, c2p_4x_table[phase]);
            }
        }
    }
}

static void c2p_screen_hirez(unsigned char *out, const unsigned char *in) {
    boolean zoom_allowed = gamestate == GS_LEVEL
        && !menuactive && !inhelpscreens && !automapactive;
    short splitline = !zoom_allowed || viewheight == SCREENHEIGHT ? SCREENHEIGHT : SCREENHEIGHT - 32;
    if (!zoom_allowed || viewwidth > SCREENWIDTH/2) {
        for (short line = 0; line < splitline; line++ ) {
            c2p_1x_hirez(out + 160*line, in + 320*line, 320, c2p_table[line&1]);
        }
    } else if(viewwidth > SCREENWIDTH/4) {
        // 2x zoom
        for (short line = 0; line < splitline; line++ ) {
            c2p_2x_hirez(out + 160*line, in + SCREENWIDTH*(42 + line/2) + 80, 160, c2p_2x_table[line&1]);
        }
    } else {
        // 4x zoom
        for (short line = 0; line < splitline; line++ ) {
            short phase = line & 3;
            if (phase < 2) {
                c2p_4x_hirez(out + 160*line, in + SCREENWIDTH*(63 + line/4) + 120, 80, c2p_4x_table[phase&1]);
            }
        }
    }
}

void c2p_screen(unsigned char *out, const unsigned char *in) {
    c2p_screen_drawfunc(out, in);
}

void c2p_statusbar(unsigned char *out, const unsigned char *in, short y_begin, short y_end, short x_begin, short x_end) {
    if (y_end <= 0 || x_end <= 0)
        return;
    boolean statusbar_drawn = gamestate == GS_LEVEL
        && !menuactive && !inhelpscreens && !automapactive && viewheight < SCREENHEIGHT;
    if (!statusbar_drawn)
        return;
    if (y_begin < SCREENHEIGHT - 32)
        y_begin = SCREENHEIGHT - 32;
    if (y_end > SCREENHEIGHT)
        y_end = SCREENHEIGHT;
    if (x_begin < 0)
        x_begin = 0;
    if (x_end > SCREENWIDTH)
        x_end = SCREENWIDTH;

    x_begin &= ~15;
    x_end = (x_end + 15) & ~15;
    //fprintf(stderr, "%d %d %d %d \r", y_begin, y_end, x_begin, x_end);

    c2p_statusbar_drawfunc(out, in, y_begin, y_end, x_begin, x_end);
}
