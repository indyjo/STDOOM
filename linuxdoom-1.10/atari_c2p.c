#include <mint/osbind.h>
#include "atari_c2p.h"
#include "w_wad.h"
#include "z_zone.h"

// Set to 1 to use grayscale medium resolution (640x200) rendering.
#define USE_MIDRES 0

// Set to 1 or higher to drop small color contributions.
#define DESPECKLE_THRESHOLD 0

#if !USE_MIDRES
static void move_p_ofs(unsigned char *p, unsigned int data, unsigned char ofs) {
	asm ("movep.l %0, %c2(%1)" : : "d" (data), "a" (p), "i" (ofs));
}

// [DOOM color 0..255][weight of ST color 0..16]
static unsigned char mix_weights[256][16] = {
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 0: 0.000000
{ 15, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,}, // 1: 0.035698
{ 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,}, // 2: 0.046426
{ 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 12, 0, 0, 0, 0,}, // 3: 0.006115
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 4: 0.000000
{ 13, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0,}, // 5: 0.026911
{ 14, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,}, // 6: 0.028584
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 7: 0.027266
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 8: 0.010087
{ 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0,}, // 9: 0.037199
{ 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0,}, // 10: 0.075388
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0,}, // 11: 0.049811
{ 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,}, // 12: 0.031830
{ 6, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0, 4, 0, 0, 0, 0,}, // 13: 0.006776
{ 12, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 2, 0, 0, 0, 0,}, // 14: 0.025478
{ 11, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 3, 0, 0, 0, 0,}, // 15: 0.020767
{ 0, 0, 0, 0, 0, 7, 0, 0, 1, 0, 0, 0, 0, 1, 7, 0,}, // 16: 0.268753
{ 0, 0, 0, 0, 0, 5, 0, 1, 3, 0, 0, 0, 0, 2, 4, 1,}, // 17: 0.090808
{ 0, 0, 0, 0, 0, 3, 0, 1, 4, 0, 0, 0, 0, 5, 1, 2,}, // 18: 0.061407
{ 0, 0, 1, 0, 0, 3, 0, 0, 5, 0, 1, 0, 0, 4, 1, 1,}, // 19: 0.020567
{ 0, 0, 1, 0, 0, 4, 0, 2, 5, 0, 1, 0, 0, 0, 3, 0,}, // 20: 0.019364
{ 0, 0, 0, 1, 0, 2, 1, 0, 8, 1, 1, 0, 0, 0, 1, 1,}, // 21: 0.015373
{ 1, 0, 0, 1, 1, 1, 0, 0, 9, 1, 0, 0, 0, 1, 0, 1,}, // 22: 0.013525
{ 0, 0, 0, 0, 0, 2, 2, 3, 4, 1, 1, 0, 0, 3, 0, 0,}, // 23: 0.009238
{ 0, 1, 1, 1, 0, 1, 1, 4, 5, 0, 0, 0, 0, 2, 0, 0,}, // 24: 0.028741
{ 0, 2, 0, 0, 1, 1, 2, 5, 5, 0, 0, 0, 0, 0, 0, 0,}, // 25: 0.016465
{ 0, 0, 1, 0, 1, 1, 0, 7, 3, 1, 0, 1, 0, 1, 0, 0,}, // 26: 0.009507
{ 2, 0, 1, 0, 1, 1, 1, 2, 6, 1, 0, 1, 0, 0, 0, 0,}, // 27: 0.011855
{ 3, 0, 3, 0, 3, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0,}, // 28: 0.012174
{ 1, 0, 0, 1, 1, 0, 3, 7, 3, 0, 0, 0, 0, 0, 0, 0,}, // 29: 0.010962
{ 1, 0, 1, 0, 2, 0, 2, 9, 1, 0, 0, 0, 0, 0, 0, 0,}, // 30: 0.020229
{ 3, 0, 0, 0, 2, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 31: 0.047579
{ 0, 0, 1, 0, 1, 0, 6, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 32: 0.063530
{ 1, 0, 0, 0, 1, 0, 7, 7, 0, 0, 0, 0, 0, 0, 0, 0,}, // 33: 0.071333
{ 1, 0, 0, 0, 1, 0, 9, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 34: 0.074886
{ 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 35: 0.175537
{ 0, 0, 1, 0, 0, 0, 12, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 36: 0.091528
{ 0, 0, 1, 0, 0, 0, 13, 2, 0, 0, 0, 0, 0, 0, 0, 0,}, // 37: 0.091170
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 38: 0.000000
{ 1, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 39: 0.043305
{ 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 40: 0.078440
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 41: 0.090580
{ 6, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 42: 0.077859
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 43: 0.060421
{ 9, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 44: 0.060921
{ 11, 0, 0, 0, 0, 0, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0,}, // 45: 0.083276
{ 11, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 46: 0.043415
{ 13, 0, 0, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0,}, // 47: 0.070961
{ 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 1, 12,}, // 48: 0.346320
{ 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 6, 7,}, // 49: 0.146373
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 7, 5,}, // 50: 0.199906
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 1, 8, 3,}, // 51: 0.396911
{ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 9, 2,}, // 52: 0.293661
{ 0, 0, 0, 0, 0, 5, 0, 0, 1, 0, 0, 0, 0, 0, 9, 1,}, // 53: 0.353884
{ 0, 0, 0, 0, 0, 5, 0, 0, 2, 0, 0, 0, 0, 0, 9, 0,}, // 54: 0.353453
{ 0, 0, 0, 0, 0, 4, 0, 0, 3, 0, 0, 0, 0, 1, 8, 0,}, // 55: 0.434756
{ 0, 0, 0, 0, 0, 3, 0, 0, 6, 0, 0, 0, 0, 0, 7, 0,}, // 56: 0.631739
{ 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 2, 3,}, // 57: 0.129211
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 58: 0.000000
{ 0, 0, 0, 0, 0, 0, 1, 0, 5, 1, 0, 0, 0, 7, 1, 1,}, // 59: 0.031848
{ 1, 0, 0, 0, 1, 0, 0, 0, 3, 0, 0, 1, 0, 9, 1, 0,}, // 60: 0.018135
{ 0, 0, 0, 0, 1, 1, 1, 2, 7, 0, 0, 0, 2, 0, 2, 0,}, // 61: 0.015626
{ 0, 2, 1, 0, 0, 0, 0, 1, 7, 0, 2, 1, 0, 1, 1, 0,}, // 62: 0.011177
{ 0, 0, 0, 1, 0, 0, 2, 0, 7, 1, 0, 1, 1, 2, 1, 0,}, // 63: 0.007980
{ 1, 0, 1, 0, 1, 0, 4, 2, 2, 0, 0, 0, 0, 3, 2, 0,}, // 64: 0.007273
{ 1, 0, 0, 0, 2, 0, 1, 5, 3, 1, 0, 0, 2, 0, 1, 0,}, // 65: 0.005859
{ 1, 0, 0, 0, 0, 0, 0, 4, 2, 5, 1, 0, 1, 2, 0, 0,}, // 66: 0.006051
{ 1, 1, 1, 0, 0, 0, 2, 6, 2, 0, 1, 0, 2, 0, 0, 0,}, // 67: 0.006566
{ 0, 0, 2, 0, 0, 0, 3, 2, 2, 0, 0, 4, 1, 2, 0, 0,}, // 68: 0.010345
{ 0, 0, 4, 0, 0, 0, 1, 0, 3, 3, 0, 4, 0, 0, 1, 0,}, // 69: 0.004402
{ 2, 0, 1, 0, 0, 0, 4, 2, 1, 2, 0, 2, 1, 1, 0, 0,}, // 70: 0.005420
{ 1, 0, 0, 0, 0, 0, 3, 4, 0, 6, 0, 1, 1, 0, 0, 0,}, // 71: 0.003333
{ 3, 0, 2, 0, 0, 0, 4, 2, 0, 1, 0, 3, 0, 0, 1, 0,}, // 72: 0.008962
{ 7, 0, 2, 0, 0, 0, 4, 1, 0, 1, 0, 0, 0, 0, 1, 0,}, // 73: 0.009468
{ 6, 0, 0, 0, 0, 0, 5, 1, 0, 2, 0, 1, 1, 0, 0, 0,}, // 74: 0.019233
{ 6, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 3, 1, 0, 0, 0,}, // 75: 0.014423
{ 10, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 1, 0, 0, 0,}, // 76: 0.047081
{ 10, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 5, 0, 0, 0, 0,}, // 77: 0.041775
{ 10, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 5, 0, 0, 0, 0,}, // 78: 0.070037
{ 12, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 3, 0, 0, 0, 0,}, // 79: 0.037948
{ 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 13,}, // 80: 0.101806
{ 0, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 11,}, // 81: 0.096832
{ 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10,}, // 82: 0.030748
{ 0, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 11,}, // 83: 0.049397
{ 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 1, 1, 2, 0, 0, 9,}, // 84: 0.036650
{ 0, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 8,}, // 85: 0.021785
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 1, 0, 3, 0, 0, 0, 9,}, // 86: 0.015455
{ 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,}, // 87: 0.001749
{ 0, 2, 1, 1, 0, 1, 2, 0, 0, 0, 1, 0, 3, 0, 0, 5,}, // 88: 0.010565
{ 0, 3, 3, 0, 0, 1, 0, 0, 0, 1, 0, 1, 2, 0, 0, 5,}, // 89: 0.010788
{ 0, 1, 1, 1, 1, 1, 3, 0, 0, 0, 0, 0, 4, 0, 0, 4,}, // 90: 0.011184
{ 2, 0, 1, 3, 0, 0, 1, 0, 0, 0, 0, 1, 2, 1, 1, 4,}, // 91: 0.011418
{ 0, 0, 0, 1, 5, 0, 2, 0, 0, 0, 0, 0, 5, 0, 0, 3,}, // 92: 0.007907
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 93: 0.000000
{ 1, 0, 0, 5, 0, 0, 1, 0, 1, 0, 1, 0, 4, 1, 1, 1,}, // 94: 0.010164
{ 7, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,}, // 95: 0.000783
{ 0, 1, 1, 1, 3, 1, 0, 0, 0, 3, 1, 0, 5, 0, 0, 0,}, // 96: 0.006873
{ 3, 2, 1, 4, 0, 0, 0, 1, 0, 1, 0, 0, 2, 0, 2, 0,}, // 97: 0.010451
{ 0, 3, 1, 2, 0, 0, 3, 0, 0, 0, 3, 2, 2, 0, 0, 0,}, // 98: 0.011553
{ 5, 0, 2, 3, 1, 0, 0, 0, 1, 0, 0, 0, 3, 0, 1, 0,}, // 99: 0.005351
{ 2, 2, 2, 2, 0, 0, 0, 1, 0, 0, 0, 4, 2, 1, 0, 0,}, // 100: 0.005752
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,}, // 101: 0.007118
{ 7, 1, 1, 1, 1, 0, 2, 0, 0, 0, 1, 0, 2, 0, 0, 0,}, // 102: 0.016176
{ 0, 0, 9, 1, 0, 0, 2, 0, 0, 0, 0, 1, 2, 1, 0, 0,}, // 103: 0.007519
{ 5, 1, 1, 1, 0, 0, 2, 0, 0, 2, 0, 3, 1, 0, 0, 0,}, // 104: 0.015321
{ 3, 1, 9, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0,}, // 105: 0.016196
{ 8, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 3, 1, 0, 0, 0,}, // 106: 0.017071
{ 4, 0, 9, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0,}, // 107: 0.013041
{ 2, 0, 6, 0, 0, 0, 0, 0, 0, 2, 0, 6, 0, 0, 0, 0,}, // 108: 0.030147
{ 6, 0, 4, 0, 0, 0, 0, 0, 0, 1, 0, 5, 0, 0, 0, 0,}, // 109: 0.020798
{ 9, 0, 3, 0, 0, 0, 0, 0, 0, 1, 0, 3, 0, 0, 0, 0,}, // 110: 0.034337
{ 11, 0, 2, 0, 0, 0, 0, 0, 0, 1, 0, 2, 0, 0, 0, 0,}, // 111: 0.025864
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 1, 3,}, // 112: 6.362360
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 1, 2,}, // 113: 4.592709
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 0, 1, 1,}, // 114: 2.970475
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 1,}, // 115: 1.506714
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,}, // 116: 0.000000
{ 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 13, 0, 0, 0,}, // 117: 0.075042
{ 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0,}, // 118: 0.197646
{ 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0,}, // 119: 0.159934
{ 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0,}, // 120: 0.143649
{ 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 5, 0, 0, 0,}, // 121: 0.105647
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0,}, // 122: 0.159517
{ 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 2, 0, 0, 0,}, // 123: 0.173265
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 1, 0, 0, 0,}, // 124: 0.169018
{ 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,}, // 125: 0.081938
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0,}, // 126: 0.093773
{ 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,}, // 127: 0.038786
{ 0, 2, 1, 0, 0, 2, 1, 0, 0, 1, 1, 1, 2, 1, 3, 1,}, // 128: 0.006692
{ 0, 1, 2, 0, 2, 0, 1, 0, 0, 2, 1, 0, 1, 2, 2, 2,}, // 129: 0.005122
{ 0, 2, 1, 0, 1, 0, 0, 1, 1, 0, 1, 5, 0, 0, 2, 2,}, // 130: 0.003348
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0,}, // 131: 0.000000
{ 4, 0, 1, 0, 0, 1, 2, 0, 0, 2, 0, 1, 1, 1, 2, 1,}, // 132: 0.005038
{ 2, 0, 0, 1, 0, 0, 1, 0, 0, 0, 6, 2, 1, 3, 0, 0,}, // 133: 0.004688
{ 0, 0, 3, 1, 1, 0, 2, 1, 0, 2, 3, 0, 1, 0, 2, 0,}, // 134: 0.005446
{ 1, 0, 6, 0, 2, 0, 0, 0, 1, 1, 1, 0, 2, 1, 1, 0,}, // 135: 0.002256
{ 1, 1, 6, 0, 0, 0, 1, 0, 0, 0, 1, 2, 1, 3, 0, 0,}, // 136: 0.004297
{ 4, 0, 0, 0, 0, 0, 5, 0, 1, 1, 0, 3, 1, 0, 0, 1,}, // 137: 0.006448
{ 0, 0, 2, 0, 2, 0, 2, 1, 0, 0, 0, 7, 1, 0, 1, 0,}, // 138: 0.002792
{ 3, 1, 3, 0, 0, 0, 3, 1, 0, 1, 0, 2, 1, 1, 0, 0,}, // 139: 0.009768
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0,}, // 140: 0.000000
{ 2, 0, 6, 0, 0, 0, 3, 0, 0, 1, 0, 3, 0, 0, 1, 0,}, // 141: 0.012747
{ 2, 0, 1, 0, 0, 0, 2, 0, 0, 7, 0, 4, 0, 0, 0, 0,}, // 142: 0.013051
{ 2, 0, 4, 0, 0, 0, 6, 0, 0, 0, 0, 3, 1, 0, 0, 0,}, // 143: 0.020698
{ 0, 4, 2, 0, 0, 0, 0, 0, 3, 1, 1, 2, 2, 1, 0, 0,}, // 144: 0.005189
{ 2, 0, 0, 0, 0, 0, 1, 0, 0, 2, 5, 4, 0, 1, 1, 0,}, // 145: 0.001930
{ 1, 0, 3, 1, 0, 0, 5, 1, 0, 1, 0, 1, 1, 0, 2, 0,}, // 146: 0.008143
{ 1, 1, 0, 0, 0, 0, 2, 2, 0, 0, 0, 8, 1, 1, 0, 0,}, // 147: 0.007731
{ 8, 0, 1, 0, 0, 0, 2, 0, 0, 3, 1, 0, 0, 0, 1, 0,}, // 148: 0.005714
{ 6, 0, 2, 0, 0, 0, 2, 0, 1, 1, 0, 3, 1, 0, 0, 0,}, // 149: 0.018390
{ 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 10, 0, 0, 0, 0,}, // 150: 0.025422
{ 9, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 5, 0, 0, 0, 0,}, // 151: 0.036430
{ 2, 0, 0, 2, 1, 0, 2, 0, 0, 0, 0, 4, 3, 0, 2, 0,}, // 152: 0.007531
{ 0, 1, 3, 0, 0, 0, 0, 0, 0, 6, 3, 1, 2, 0, 0, 0,}, // 153: 0.008730
{ 6, 1, 2, 0, 1, 0, 1, 0, 0, 1, 0, 0, 3, 1, 0, 0,}, // 154: 0.010407
{ 5, 1, 2, 0, 0, 0, 1, 0, 0, 4, 1, 0, 2, 0, 0, 0,}, // 155: 0.010612
{ 2, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 10, 1, 0, 0, 0,}, // 156: 0.014856
{ 5, 0, 4, 0, 0, 0, 3, 0, 0, 1, 0, 1, 2, 0, 0, 0,}, // 157: 0.014102
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0,}, // 158: 0.000000
{ 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0,}, // 159: 0.026001
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 2,}, // 160: 2.718138
{ 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 12, 0,}, // 161: 0.068437
{ 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 2, 1, 8, 0,}, // 162: 0.032296
{ 6, 0, 0, 0, 0, 0, 1, 0, 3, 0, 0, 0, 0, 0, 6, 0,}, // 163: 0.042309
{ 6, 0, 0, 0, 0, 0, 2, 0, 4, 0, 0, 1, 0, 0, 3, 0,}, // 164: 0.108830
{ 8, 0, 0, 0, 0, 0, 1, 1, 4, 0, 0, 1, 0, 0, 1, 0,}, // 165: 0.078674
{ 7, 0, 0, 0, 0, 0, 1, 2, 3, 0, 0, 3, 0, 0, 0, 0,}, // 166: 0.085113
{ 9, 0, 0, 0, 0, 0, 2, 5, 0, 0, 0, 0, 0, 0, 0, 0,}, // 167: 0.015639
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 168: 0.000000
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 1, 4, 7,}, // 169: 0.141205
{ 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 1, 8, 0,}, // 170: 0.412272
{ 0, 0, 0, 0, 0, 5, 0, 0, 7, 0, 0, 0, 0, 0, 4, 0,}, // 171: 0.704940
{ 0, 0, 0, 0, 0, 3, 0, 0, 12, 0, 0, 0, 0, 0, 1, 0,}, // 172: 1.230145
{ 0, 0, 0, 0, 0, 2, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0,}, // 173: 1.734514
{ 0, 0, 0, 0, 0, 1, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0,}, // 174: 2.557172
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 175: 3.049499
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 176: 3.181667
{ 0, 0, 0, 0, 0, 0, 0, 3, 13, 0, 0, 0, 0, 0, 0, 0,}, // 177: 2.522725
{ 0, 0, 0, 0, 0, 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0,}, // 178: 2.136029
{ 0, 0, 0, 0, 0, 0, 0, 9, 7, 0, 0, 0, 0, 0, 0, 0,}, // 179: 1.775749
{ 0, 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0, 0,}, // 180: 1.434762
{ 0, 0, 0, 0, 0, 0, 0, 15, 1, 0, 0, 0, 0, 0, 0, 0,}, // 181: 1.117917
{ 0, 0, 0, 0, 0, 0, 2, 14, 0, 0, 0, 0, 0, 0, 0, 0,}, // 182: 0.872011
{ 0, 0, 0, 0, 0, 0, 5, 11, 0, 0, 0, 0, 0, 0, 0, 0,}, // 183: 0.683492
{ 0, 0, 0, 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 184: 0.517555
{ 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 185: 0.306302
{ 1, 0, 0, 0, 0, 0, 13, 2, 0, 0, 0, 0, 0, 0, 0, 0,}, // 186: 0.203086
{ 1, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 187: 0.109800
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 188: 0.107125
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 189: 0.068030
{ 11, 0, 0, 0, 0, 0, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0,}, // 190: 0.083276
{ 13, 0, 0, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0,}, // 191: 0.070961
{ 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13,}, // 192: 1.186845
{ 0, 0, 0, 6, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9,}, // 193: 2.456092
{ 0, 0, 0, 8, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 194: 3.414594
{ 0, 0, 0, 10, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,}, // 195: 4.191635
{ 0, 0, 0, 11, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,}, // 196: 4.837995
{ 0, 0, 0, 13, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,}, // 197: 5.340315
{ 0, 0, 0, 13, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 198: 5.636375
{ 0, 0, 0, 14, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 199: 5.793182
{ 0, 0, 0, 14, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 200: 5.837449
{ 0, 0, 0, 15, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 201: 2.499335
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 202: 0.000000
{ 3, 0, 1, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 203: 0.019269
{ 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 204: 0.026965
{ 9, 0, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 205: 0.003007
{ 4, 0, 9, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 206: 0.011135
{ 12, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 207: 0.023033
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 208: 0.000000
{ 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 5, 9,}, // 209: 0.121584
{ 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 2, 7, 4,}, // 210: 0.372877
{ 0, 0, 0, 0, 0, 5, 0, 0, 1, 0, 0, 0, 0, 0, 10, 0,}, // 211: 0.346259
{ 0, 0, 0, 0, 0, 3, 0, 0, 6, 0, 0, 0, 0, 0, 7, 0,}, // 212: 0.666154
{ 0, 0, 0, 0, 0, 1, 0, 0, 10, 0, 0, 0, 0, 0, 5, 0,}, // 213: 1.032808
{ 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 3, 0,}, // 214: 1.360447
{ 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 1, 0,}, // 215: 1.497260
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 216: 0.000000
{ 1, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0,}, // 217: 0.133343
{ 1, 0, 0, 0, 0, 0, 1, 2, 12, 0, 0, 0, 0, 0, 0, 0,}, // 218: 0.053792
{ 0, 0, 0, 0, 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0,}, // 219: 0.076846
{ 0, 0, 0, 0, 0, 0, 2, 8, 6, 0, 0, 0, 0, 0, 0, 0,}, // 220: 0.075777
{ 0, 0, 0, 0, 0, 0, 2, 10, 4, 0, 0, 0, 0, 0, 0, 0,}, // 221: 0.120423
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 222: 0.000000
{ 0, 0, 0, 0, 0, 0, 4, 11, 1, 0, 0, 0, 0, 0, 0, 0,}, // 223: 0.047738
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 224: 0.000000
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 11,}, // 225: 1.027807
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 7,}, // 226: 1.763456
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 4,}, // 227: 2.348186
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 2,}, // 228: 2.773026
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 1,}, // 229: 3.089077
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 230: 3.220928
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 231: 3.281104
{ 1, 0, 0, 0, 0, 0, 3, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 232: 0.041616
{ 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0, 0, 0,}, // 233: 0.046399
{ 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0,}, // 234: 0.054786
{ 0, 0, 0, 0, 0, 0, 13, 3, 0, 0, 0, 0, 0, 0, 0, 0,}, // 235: 0.105421
{ 7, 0, 0, 0, 0, 0, 0, 1, 0, 4, 0, 4, 0, 0, 0, 0,}, // 236: 0.008104
{ 7, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 6, 0, 0, 0, 0,}, // 237: 0.024555
{ 13, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0,}, // 238: 0.036861
{ 13, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0,}, // 239: 0.056341
{ 12, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 240: 0.023033
{ 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 241: 0.000000
{ 5, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 242: 0.021011
{ 10, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 243: 0.027143
{ 13, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 244: 0.022332
{ 15, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 245: 0.020245
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 246: 0.015742
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 247: 0.000000
{ 0, 0, 0, 0, 0, 1, 0, 0, 10, 0, 0, 0, 0, 0, 5, 0,}, // 248: 1.171702
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 249: 0.000000
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 250: 0.000000
{ 0, 0, 0, 0, 1, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 251: 3.128808
{ 0, 0, 0, 0, 9, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 252: 1.401069
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 253: 0.000000
{ 1, 0, 2, 2, 3, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 254: 0.041614
{ 0, 0, 4, 0, 4, 0, 2, 0, 0, 0, 0, 1, 0, 4, 1, 0,}, // 255: 0.002482
};
#endif

// [phase 0..3][pixel 0..7][color 0..255]
static unsigned long c2p_table[4][8][256];

static unsigned short convert_channel(unsigned char v) {
    unsigned short r = (v & 0xe0) >> 5; // Bits 7,6,5 shifted to 2,1,0
    r |= (v & 0x10) >> 1; // STe color bit
    return r;
}
static unsigned short stcolor(unsigned char r, unsigned char g, unsigned char b) {
    unsigned short entry = convert_channel(r);
    entry <<= 4;
    entry |= convert_channel(g);
    entry <<= 4;
    entry |= convert_channel(b);
    return entry;
}

void install_palette(unsigned short *palette) {
    volatile unsigned short *reg = (unsigned short*) 0xff8240;
#if USE_MIDRES
    short numColors = 4;
#else
    short numColors = 16;
#endif
    for (short n=0; n<numColors; n++) *reg++ = *palette++;
}

#if !USE_MIDRES
void adapt_weights(unsigned char *w) {
    int sum = 0;
    for (int i=0; i<16; i++) {
        if (w[i] > DESPECKLE_THRESHOLD) sum += w[i];
    }
    int accum = 0;
    for (int i=15; i>=0; i--) {
        int last = accum;
        if (w[i] > DESPECKLE_THRESHOLD) accum += w[i];
        w[i] = 16 * accum / sum - 16 * last / sum;
    }

}
#endif

void init_c2p_table() {
	unsigned short bayer[4][4] = {
		{0,  8, 2,10},
		{12, 4,14, 6},
		{ 3,11, 1, 9},
		{15, 7,13, 5}
	};
    set_doom_palette(W_CacheLumpName("PLAYPAL", PU_CACHE));
#if USE_MIDRES
    unsigned short stpalette[] = {stcolor(0,0,0), stcolor(85,85,85), stcolor(170,170,170), stcolor(255,255,255)};
    install_palette(stpalette);

    unsigned char* palette = W_CacheLumpName("PLAYPAL", PU_CACHE);
    for (int i=0; i<256; i++) {
        unsigned short r=palette[3*i], g=palette[3*i+1], b=palette[3*i+2];
        // printf("C %d: %d %d %d\n", i, r, g, b);
        // calculate brightness (0..765)
        unsigned short l = r+g+b;
        // calculate weights (0..255) of color indices 0, 1, 2, 3
        unsigned short w[] = {
            l < 256 ? 255 - l : 0,
            l < 256 ? l : (l < 512 ? 511 - l : 0),
            l < 256 ? 0 : (l < 512 ? l - 256 : 767 - l),
            l < 512 ? 0 : (l - 512),
        };
        // make weights cumulative
        for (int j=0; j<3; j++) w[j+1] += w[j];
        // renormalize weights into bayer range 0..15
        // for (int j=0; j<4; j++) w[j] >>= 4;
        // printf("  w: %2d %2d %2d %2d\n", w[0], w[1], w[2], w[3]);

        for (int phase=0; phase<4; phase++) {
            // iterate over 8 consecutive input pixels
            unsigned long combined_pdata = 0;
            for (int px = 0; px < 8; px++) {
                unsigned long pdata = 0;
                // per input pixel, iterate over two output pixels
                for (int opx = 2*px; opx < 2*px+2; opx++) {
                    // Fetch bayer threshold for output pixel.
                    unsigned short bayer_w = (bayer[phase][opx % 4] << 4) + 7;
                    // Iterate four possible output colors.
                    // Select first one that has cumulative weight >= bayer threshold.
                    // Apply bits to pixel data in opx position.
                    for (int oc = 0; oc < 4; oc++) {
                        if (oc < 3 && w[oc] < bayer_w) continue;
                        if (oc & 1) pdata |= 0x80000000 >> opx;
                        if (oc & 2) pdata |= 0x00008000 >> opx;
                        break;
                    }
                }
                c2p_table[phase][px][i] = pdata;
                combined_pdata |= pdata;
            }
        }
    }
#else
	for (int i=0; i<256; i++) {
        unsigned char *weights = mix_weights[i];
        adapt_weights(weights);
        for (int phase=0; phase<4; phase++) {
            for (int px=0; px<8; px++) {
                // Find the ST palette color index to fill the pixel with.
                int bayer_lwb = 0, bayer_upb = 0;
                for (int c=0; c<16; c++) {
                    bayer_upb += weights[c];
                    if (bayer[phase][px%4] >= bayer_lwb && bayer[phase][px%4] < bayer_upb) {
                        unsigned long pdata = 0;
                        if (c & 1) pdata |= 0x01000000;
                        if (c & 2) pdata |= 0x00010000;
                        if (c & 4) pdata |= 0x00000100;
                        if (c & 8) pdata |= 0x00000001;
                        pdata <<= 7-px;
                        c2p_table[phase][px][i] = pdata;
                        break; // Search for color is finished. Continue with next pixel.
                    }
                    bayer_lwb += weights[c];
                }
            }
        }
	}
#endif
}

inline void c2p(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned char phase) {
#if USE_MIDRES
	while (pixels > 7) {
		register unsigned long pdata = 0;
        for(int i=0; i<8; i++) {
            pdata |= c2p_table[phase][i][*in++];
        }
        *(unsigned long*)out = pdata;
		pixels -= 8;
		out += 4;
	}
#else
	while (pixels > 15) {
		register unsigned int pdata; // 8 pixel data for use with movep
		for (int j=0; j<2; j++) {
			pdata = 0;
			for(int i=0; i<8; i++) {
				pdata |= c2p_table[phase][i][*in++];
			}
			move_p_ofs(out, pdata, j);
		}
		pixels -= 16;
		out += 8;
	}
#endif
}

const unsigned char subset[] = {0, 93, 241, 202, 253, 250, 38, 222, 216, 140, 131, 158, 116, 58, 249, 4};

void set_doom_palette(const unsigned char *colors) {
#if USE_MIDRES
    // do nothing
#else
    unsigned short stpalette[sizeof(subset)];
    for (int i=0; i<sizeof(subset); i++) {
        const unsigned char *c = &colors[3*subset[i]];
        stpalette[i] = stcolor(c[0], c[1], c[2]);
    }
    install_palette(stpalette);
#endif
}