#include <mint/osbind.h>
#include "atari_c2p.h"
#include "w_wad.h"
#include "z_zone.h"

// Set to 1 to use grayscale medium resolution (640x200) rendering.
#define USE_MIDRES 0

#if !USE_MIDRES
static void move_p_ofs(unsigned char *p, unsigned int data, unsigned char ofs) {
	asm ("movep.l %0, %c2(%1)" : : "d" (data), "a" (p), "i" (ofs));
}

// [DOOM color 0..255][weight of ST color 0..16]
static unsigned char mix_weights[256][16] = {
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 0: 0
{ 12, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0,}, // 1: 121
{ 13, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 2, 0, 0, 0, 0,}, // 2: 299
{ 3, 1, 6, 0, 0, 1, 0, 0, 0, 1, 0, 0, 2, 0, 2, 0,}, // 3: 11
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 4: 0
{ 10, 1, 2, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0,}, // 5: 116
{ 14, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 6: 12
{ 13, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0,}, // 7: 585
{ 14, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,}, // 8: 1406
{ 6, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 6, 2, 0, 0, 0,}, // 9: 163
{ 11, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 3, 0, 0, 0,}, // 10: 1066
{ 13, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0, 0, 0,}, // 11: 3974
{ 14, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0,}, // 12: 18633
{ 4, 1, 0, 1, 0, 0, 1, 3, 0, 1, 0, 4, 1, 0, 0, 0,}, // 13: 11
{ 7, 0, 1, 0, 0, 0, 2, 1, 1, 0, 0, 2, 1, 0, 0, 1,}, // 14: 16
{ 5, 0, 1, 0, 0, 0, 1, 2, 0, 2, 0, 5, 0, 0, 0, 0,}, // 15: 17
{ 0, 0, 0, 0, 0, 7, 0, 0, 1, 0, 0, 0, 0, 0, 5, 3,}, // 16: 1568
{ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 7, 2, 2,}, // 17: 336
{ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 1, 0, 0, 7, 2, 1,}, // 18: 144
{ 0, 0, 0, 0, 1, 4, 0, 2, 0, 0, 0, 0, 0, 5, 2, 2,}, // 19: 61
{ 0, 3, 0, 0, 0, 5, 0, 0, 5, 0, 0, 0, 0, 1, 1, 1,}, // 20: 32
{ 0, 0, 1, 0, 1, 4, 0, 1, 2, 0, 0, 0, 0, 4, 2, 1,}, // 21: 14
{ 0, 0, 0, 0, 5, 0, 0, 0, 3, 0, 0, 0, 0, 4, 2, 2,}, // 22: 33
{ 0, 0, 0, 0, 0, 5, 0, 0, 6, 3, 2, 0, 0, 0, 0, 0,}, // 23: 0
{ 0, 1, 0, 0, 2, 3, 0, 4, 1, 0, 0, 1, 0, 3, 1, 0,}, // 24: 20
{ 0, 0, 0, 1, 4, 0, 0, 0, 6, 1, 0, 0, 0, 2, 1, 1,}, // 25: 2
{ 0, 0, 0, 0, 3, 2, 1, 2, 3, 0, 0, 2, 0, 2, 1, 0,}, // 26: 21
{ 0, 0, 0, 0, 3, 2, 3, 0, 4, 1, 0, 1, 0, 0, 2, 0,}, // 27: 1
{ 0, 1, 0, 1, 1, 2, 3, 2, 5, 1, 0, 0, 0, 0, 0, 0,}, // 28: 17
{ 0, 0, 0, 0, 3, 0, 5, 4, 2, 0, 0, 0, 0, 0, 0, 2,}, // 29: 9
{ 0, 0, 0, 0, 0, 3, 7, 4, 1, 1, 0, 0, 0, 0, 0, 0,}, // 30: 48
{ 1, 0, 0, 0, 3, 1, 2, 6, 1, 0, 0, 1, 0, 1, 0, 0,}, // 31: 34
{ 0, 1, 0, 0, 3, 0, 5, 5, 1, 1, 0, 0, 0, 0, 0, 0,}, // 32: 26
{ 0, 0, 0, 0, 2, 0, 9, 3, 0, 0, 0, 0, 0, 2, 0, 0,}, // 33: 61
{ 3, 0, 0, 0, 3, 0, 5, 0, 5, 0, 0, 0, 0, 0, 0, 0,}, // 34: 54
{ 0, 0, 0, 0, 2, 0, 9, 4, 0, 1, 0, 0, 0, 0, 0, 0,}, // 35: 596
{ 0, 0, 1, 0, 1, 0, 11, 2, 1, 0, 0, 0, 0, 0, 0, 0,}, // 36: 593
{ 1, 0, 0, 0, 1, 0, 12, 1, 1, 0, 0, 0, 0, 0, 0, 0,}, // 37: 1745
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 38: 0
{ 1, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 39: 6387
{ 2, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 40: 15564
{ 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 41: 40459
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 42: 62256
{ 4, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 43: 54576
{ 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 44: 40123
{ 6, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 45: 111276
{ 7, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 46: 89923
{ 8, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 47: 82112
{ 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 3, 11,}, // 48: 1040
{ 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 3, 10,}, // 49: 1232
{ 0, 0, 0, 0, 0, 2, 0, 0, 1, 0, 0, 0, 0, 1, 3, 9,}, // 50: 1104
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6,}, // 51: 1088
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 1, 6, 5,}, // 52: 288
{ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 1, 7, 3,}, // 53: 896
{ 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 9, 1,}, // 54: 656
{ 0, 0, 0, 0, 0, 5, 0, 0, 2, 0, 0, 0, 0, 0, 7, 2,}, // 55: 992
{ 0, 0, 0, 0, 0, 5, 0, 0, 3, 0, 0, 0, 0, 0, 7, 1,}, // 56: 3104
{ 0, 0, 0, 0, 1, 3, 0, 0, 4, 0, 0, 0, 0, 0, 6, 2,}, // 57: 393
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0,}, // 58: 0
{ 0, 0, 0, 0, 0, 1, 0, 0, 5, 1, 1, 0, 0, 5, 1, 2,}, // 59: 16
{ 0, 1, 0, 0, 0, 2, 1, 0, 4, 0, 2, 0, 0, 3, 3, 0,}, // 60: 16
{ 0, 0, 0, 0, 0, 2, 1, 4, 3, 0, 0, 0, 1, 1, 2, 2,}, // 61: 0
{ 0, 3, 0, 0, 0, 2, 0, 6, 1, 0, 0, 0, 0, 1, 3, 0,}, // 62: 20
{ 0, 0, 0, 0, 0, 2, 0, 1, 6, 2, 0, 2, 0, 0, 2, 1,}, // 63: 1
{ 1, 1, 0, 0, 0, 1, 0, 5, 0, 1, 1, 0, 0, 4, 2, 0,}, // 64: 6
{ 0, 0, 0, 0, 2, 0, 2, 1, 4, 2, 0, 0, 2, 0, 2, 1,}, // 65: 5
{ 0, 1, 0, 0, 1, 0, 0, 0, 6, 2, 0, 4, 0, 0, 1, 1,}, // 66: 1
{ 0, 1, 0, 0, 0, 0, 4, 3, 0, 0, 0, 3, 0, 2, 2, 1,}, // 67: 1
{ 3, 3, 0, 1, 0, 0, 1, 1, 5, 0, 0, 0, 0, 0, 2, 0,}, // 68: 0
{ 4, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0, 3, 0, 2, 0, 1,}, // 69: 0
{ 3, 0, 1, 0, 1, 0, 0, 1, 4, 1, 2, 1, 1, 0, 1, 0,}, // 70: 1
{ 2, 0, 0, 0, 0, 1, 2, 2, 1, 1, 0, 5, 0, 0, 2, 0,}, // 71: 8
{ 6, 1, 0, 0, 0, 0, 0, 4, 1, 1, 1, 0, 0, 0, 1, 1,}, // 72: 12
{ 4, 0, 0, 0, 0, 0, 4, 1, 0, 1, 0, 2, 1, 2, 1, 0,}, // 73: 1
{ 6, 1, 1, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 0, 2, 0,}, // 74: 11
{ 5, 0, 1, 0, 0, 0, 3, 1, 0, 0, 0, 3, 1, 0, 2, 0,}, // 75: 12
{ 6, 0, 0, 0, 0, 0, 3, 2, 0, 0, 1, 2, 2, 0, 0, 0,}, // 76: 8
{ 8, 0, 0, 0, 0, 0, 1, 0, 1, 2, 0, 3, 0, 0, 1, 0,}, // 77: 96
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 2, 0,}, // 78: 96
{ 10, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 2, 1, 0, 0, 0,}, // 79: 152
{ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15,}, // 80: 3
{ 0, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 12,}, // 81: 544
{ 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14,}, // 82: 12
{ 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12,}, // 83: 243
{ 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 12,}, // 84: 225
{ 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8,}, // 85: 0
{ 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 2, 0, 0, 0, 11,}, // 86: 74
{ 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 1, 0, 0, 9,}, // 87: 17
{ 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 1, 10,}, // 88: 50
{ 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 2, 0, 1, 8,}, // 89: 13
{ 2, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 90: 12
{ 0, 1, 2, 0, 1, 0, 0, 0, 0, 0, 2, 1, 2, 0, 0, 7,}, // 91: 13
{ 3, 0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 1, 0, 0, 7,}, // 92: 17
{ 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 93: 0
{ 0, 1, 0, 2, 0, 1, 0, 0, 0, 0, 0, 4, 2, 1, 1, 4,}, // 94: 8
{ 1, 0, 1, 2, 0, 1, 0, 0, 0, 1, 2, 0, 3, 1, 1, 3,}, // 95: 1
{ 0, 0, 3, 1, 0, 0, 0, 0, 0, 1, 3, 2, 1, 0, 1, 4,}, // 96: 0
{ 1, 1, 3, 0, 0, 0, 0, 0, 0, 5, 0, 0, 1, 0, 0, 5,}, // 97: 1
{ 0, 1, 4, 0, 0, 0, 0, 0, 0, 1, 4, 2, 1, 0, 0, 3,}, // 98: 0
{ 0, 4, 2, 1, 1, 1, 1, 1, 0, 0, 0, 0, 5, 0, 0, 0,}, // 99: 2
{ 0, 0, 1, 3, 0, 1, 0, 0, 0, 3, 0, 2, 3, 1, 2, 0,}, // 100: 0
{ 3, 3, 1, 2, 0, 0, 1, 0, 1, 0, 0, 0, 3, 1, 0, 1,}, // 101: 9
{ 0, 0, 1, 3, 1, 0, 2, 1, 0, 1, 0, 1, 5, 0, 1, 0,}, // 102: 2
{ 3, 0, 0, 4, 0, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0,}, // 103: 3
{ 9, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,}, // 104: 3
{ 0, 0, 6, 0, 0, 0, 1, 0, 0, 1, 0, 5, 1, 0, 1, 1,}, // 105: 8
{ 2, 0, 5, 0, 1, 0, 0, 1, 0, 0, 2, 2, 3, 0, 0, 0,}, // 106: 10
{ 3, 0, 6, 0, 0, 0, 0, 0, 0, 0, 1, 3, 1, 1, 1, 0,}, // 107: 19
{ 3, 0, 4, 1, 0, 0, 2, 0, 1, 0, 0, 2, 3, 0, 0, 0,}, // 108: 17
{ 11, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 109: 27
{ 6, 0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 6, 1, 0, 0, 0,}, // 110: 165
{ 13, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,}, // 111: 27
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 4,}, // 112: 669952
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 3,}, // 113: 382096
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 2,}, // 114: 175168
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 1,}, // 115: 49168
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,}, // 116: 0
{ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 14, 0, 0, 0,}, // 117: 3275
{ 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0,}, // 118: 4371
{ 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0,}, // 119: 8624
{ 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0,}, // 120: 13763
{ 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 9, 0, 0, 0,}, // 121: 6860
{ 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0,}, // 122: 8896
{ 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0,}, // 123: 14891
{ 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 5, 0, 0, 0,}, // 124: 7500
{ 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0,}, // 125: 8496
{ 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0,}, // 126: 4851
{ 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,}, // 127: 2348
{ 0, 9, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 4, 0,}, // 128: 0
{ 0, 2, 1, 0, 0, 2, 0, 0, 0, 2, 0, 2, 0, 0, 4, 3,}, // 129: 2
{ 0, 1, 0, 0, 1, 0, 0, 0, 1, 4, 1, 1, 1, 1, 1, 4,}, // 130: 1
{ 0, 0, 0, 0, 0, 0, 0, 0, 2, 6, 1, 2, 0, 0, 0, 5,}, // 131: 0
{ 4, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 3, 3,}, // 132: 1
{ 3, 3, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 2, 2, 2,}, // 133: 1
{ 0, 1, 0, 0, 0, 3, 0, 1, 0, 3, 0, 4, 2, 0, 2, 0,}, // 134: 1
{ 3, 1, 0, 1, 0, 0, 2, 2, 0, 1, 0, 0, 1, 0, 2, 3,}, // 135: 1
{ 1, 1, 3, 0, 0, 1, 1, 0, 2, 0, 2, 0, 3, 2, 0, 0,}, // 136: 1
{ 1, 0, 3, 0, 0, 0, 2, 0, 1, 1, 1, 1, 2, 3, 0, 1,}, // 137: 1
{ 3, 0, 0, 1, 0, 1, 1, 0, 1, 3, 0, 1, 2, 2, 1, 0,}, // 138: 1
{ 5, 1, 0, 0, 0, 0, 0, 0, 1, 3, 5, 0, 0, 1, 0, 0,}, // 139: 3
{ 4, 2, 0, 0, 0, 0, 2, 0, 0, 3, 1, 1, 1, 2, 0, 0,}, // 140: 0
{ 4, 1, 0, 1, 0, 0, 1, 2, 0, 3, 1, 1, 1, 0, 1, 0,}, // 141: 6
{ 5, 0, 1, 1, 0, 0, 1, 1, 1, 1, 2, 1, 1, 0, 1, 0,}, // 142: 6
{ 4, 2, 1, 0, 0, 0, 1, 1, 1, 0, 1, 5, 0, 0, 0, 0,}, // 143: 3
{ 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 5, 1, 3, 1, 1, 0,}, // 144: 1
{ 0, 1, 2, 2, 0, 0, 1, 0, 2, 1, 0, 1, 1, 0, 5, 0,}, // 145: 0
{ 0, 0, 4, 0, 0, 0, 0, 0, 2, 2, 3, 1, 1, 1, 2, 0,}, // 146: 0
{ 3, 2, 1, 0, 1, 0, 1, 1, 1, 2, 0, 0, 2, 0, 2, 0,}, // 147: 1
{ 3, 2, 0, 0, 0, 0, 6, 0, 0, 1, 0, 0, 3, 0, 1, 0,}, // 148: 3
{ 6, 0, 0, 0, 1, 0, 1, 2, 0, 0, 0, 1, 3, 2, 0, 0,}, // 149: 5
{ 4, 1, 1, 0, 0, 0, 1, 3, 0, 1, 0, 4, 1, 0, 0, 0,}, // 150: 3
{ 7, 0, 1, 0, 0, 0, 2, 0, 2, 1, 0, 1, 2, 0, 0, 0,}, // 151: 41
{ 3, 3, 0, 0, 0, 0, 1, 0, 0, 2, 1, 0, 3, 1, 0, 2,}, // 152: 3
{ 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 3, 4, 0, 0, 2,}, // 153: 6
{ 1, 0, 2, 0, 0, 0, 0, 0, 0, 5, 0, 2, 3, 2, 0, 1,}, // 154: 3
{ 4, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 4, 3, 0, 2, 0,}, // 155: 2
{ 4, 0, 2, 0, 0, 0, 2, 0, 1, 0, 1, 1, 4, 0, 0, 1,}, // 156: 8
{ 6, 0, 2, 0, 0, 1, 0, 1, 1, 0, 0, 0, 5, 0, 0, 0,}, // 157: 1
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0,}, // 158: 0
{ 10, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 3, 0, 1, 0,}, // 159: 76
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 4,}, // 160: 89344
{ 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 13, 0,}, // 161: 96
{ 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 0, 0, 1, 0, 10, 0,}, // 162: 224
{ 1, 0, 0, 0, 0, 0, 1, 3, 2, 0, 0, 0, 2, 0, 7, 0,}, // 163: 226
{ 2, 0, 0, 0, 0, 0, 0, 6, 2, 0, 0, 0, 2, 0, 4, 0,}, // 164: 296
{ 0, 0, 0, 0, 0, 0, 1, 11, 0, 0, 0, 1, 3, 0, 0, 0,}, // 165: 209
{ 3, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 1, 1, 0, 0, 0,}, // 166: 990
{ 6, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 167: 584
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 168: 0
{ 0, 0, 0, 0, 0, 3, 0, 0, 1, 0, 0, 0, 0, 0, 2, 10,}, // 169: 464
{ 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3,}, // 170: 464
{ 0, 0, 0, 0, 0, 8, 0, 0, 3, 0, 0, 0, 0, 0, 5, 0,}, // 171: 1328
{ 0, 0, 0, 0, 0, 6, 0, 0, 9, 0, 0, 0, 0, 0, 0, 1,}, // 172: 15840
{ 0, 0, 0, 0, 2, 4, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0,}, // 173: 113828
{ 0, 0, 0, 0, 4, 1, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0,}, // 174: 425056
{ 0, 0, 0, 0, 3, 0, 0, 4, 9, 0, 0, 0, 0, 0, 0, 0,}, // 175: 1176161
{ 0, 0, 0, 0, 2, 0, 0, 11, 3, 0, 0, 0, 0, 0, 0, 0,}, // 176: 2451917
{ 0, 0, 0, 0, 2, 0, 0, 13, 1, 0, 0, 0, 0, 0, 0, 0,}, // 177: 1969789
{ 0, 0, 0, 0, 2, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0,}, // 178: 1649640
{ 0, 0, 0, 0, 2, 0, 1, 13, 0, 0, 0, 0, 0, 0, 0, 0,}, // 179: 1395181
{ 0, 0, 0, 0, 2, 0, 2, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 180: 1179156
{ 0, 0, 0, 0, 1, 0, 5, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 181: 976309
{ 0, 0, 0, 0, 1, 0, 7, 8, 0, 0, 0, 0, 0, 0, 0, 0,}, // 182: 797761
{ 0, 0, 0, 0, 0, 0, 10, 6, 0, 0, 0, 0, 0, 0, 0, 0,}, // 183: 630692
{ 0, 0, 0, 0, 0, 0, 12, 4, 0, 0, 0, 0, 0, 0, 0, 0,}, // 184: 492176
{ 0, 0, 0, 0, 0, 0, 14, 2, 0, 0, 0, 0, 0, 0, 0, 0,}, // 185: 355844
{ 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 186: 287232
{ 2, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 187: 237644
{ 3, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 188: 189003
{ 5, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 189: 149627
{ 6, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 190: 111276
{ 8, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 191: 82112
{ 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14,}, // 192: 19354
{ 0, 0, 0, 3, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12,}, // 193: 41498
{ 0, 0, 0, 5, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10,}, // 194: 76330
{ 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9,}, // 195: 132594
{ 0, 0, 0, 8, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,}, // 196: 217152
{ 0, 0, 0, 10, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,}, // 197: 315048
{ 0, 0, 0, 12, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,}, // 198: 409040
{ 0, 0, 0, 14, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,}, // 199: 538984
{ 0, 0, 0, 15, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 200: 688554
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 201: 147456
{ 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 202: 0
{ 0, 0, 3, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 203: 144
{ 0, 0, 6, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 204: 576
{ 5, 0, 1, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 205: 25
{ 3, 0, 7, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 206: 9
{ 1, 0, 13, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 207: 1
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 208: 0
{ 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 2, 12,}, // 209: 400
{ 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6,}, // 210: 1088
{ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 9, 2,}, // 211: 800
{ 0, 0, 0, 0, 0, 4, 0, 0, 3, 0, 0, 0, 0, 1, 7, 1,}, // 212: 3024
{ 0, 0, 0, 0, 0, 3, 0, 0, 6, 0, 0, 0, 0, 1, 6, 0,}, // 213: 7888
{ 0, 0, 0, 0, 0, 1, 0, 0, 11, 0, 0, 0, 0, 0, 3, 1,}, // 214: 21664
{ 0, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 2, 0,}, // 215: 31424
{ 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0,}, // 216: 0
{ 0, 0, 0, 0, 0, 0, 0, 2, 14, 0, 0, 0, 0, 0, 0, 0,}, // 217: 7364
{ 0, 0, 0, 0, 0, 0, 0, 5, 11, 0, 0, 0, 0, 0, 0, 0,}, // 218: 1353
{ 0, 0, 0, 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0, 0,}, // 219: 1889
{ 0, 0, 0, 0, 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0,}, // 220: 1705
{ 0, 0, 0, 0, 0, 0, 0, 13, 3, 0, 0, 0, 0, 0, 0, 0,}, // 221: 4921
{ 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0,}, // 222: 0
{ 1, 0, 0, 0, 0, 0, 0, 14, 1, 0, 0, 0, 0, 0, 0, 0,}, // 223: 1923
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16,}, // 224: 0
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 13,}, // 225: 15184
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 9,}, // 226: 30160
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 6,}, // 227: 57664
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 3,}, // 228: 98128
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 229: 151552
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 230: 557056
{ 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 15, 0,}, // 231: 1566745
{ 1, 0, 0, 0, 0, 0, 1, 14, 0, 0, 0, 0, 0, 0, 0, 0,}, // 232: 691
{ 1, 0, 0, 0, 0, 0, 3, 12, 0, 0, 0, 0, 0, 0, 0, 0,}, // 233: 6523
{ 2, 0, 0, 0, 0, 0, 4, 10, 0, 0, 0, 0, 0, 0, 0, 0,}, // 234: 13080
{ 2, 0, 0, 0, 0, 0, 7, 7, 0, 0, 0, 0, 0, 0, 0, 0,}, // 235: 37641
{ 7, 0, 0, 0, 0, 0, 4, 1, 0, 0, 1, 0, 2, 0, 0, 1,}, // 236: 2
{ 9, 1, 0, 0, 0, 0, 1, 2, 0, 1, 0, 0, 1, 1, 0, 0,}, // 237: 11
{ 8, 0, 1, 0, 0, 0, 2, 1, 1, 0, 0, 2, 1, 0, 0, 0,}, // 238: 27
{ 10, 0, 1, 0, 0, 0, 1, 3, 0, 0, 0, 0, 1, 0, 0, 0,}, // 239: 83
{ 1, 0, 13, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 240: 1
{ 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 241: 0
{ 10, 0, 2, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 242: 100
{ 11, 0, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 243: 1
{ 10, 0, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 244: 4
{ 11, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 245: 169
{ 15, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 246: 729
{ 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 247: 0
{ 0, 0, 0, 0, 0, 1, 0, 0, 9, 0, 0, 0, 0, 0, 5, 1,}, // 248: 12640
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0,}, // 249: 0
{ 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 250: 0
{ 0, 0, 0, 0, 7, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 251: 2167033
{ 0, 0, 0, 0, 11, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 252: 571393
{ 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 253: 0
{ 5, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,}, // 254: 778
{ 0, 2, 0, 0, 0, 2, 4, 0, 0, 1, 3, 1, 0, 3, 0, 0,}, // 255: 0
};
#endif

// [phase 0..3][pixel 0..7][color 0..255]
static unsigned long c2p_table[4][8][256];

static unsigned short convert_channel(unsigned char v) {
    unsigned short r = (v & 0xe0) >> 5; // Bits 7,6,5 shifted to 2,1,0
    r |= (v & 0x10) >> 1; // STe color bit
    return r;
}
static unsigned short stcolor(unsigned char r, unsigned char g, unsigned char b) {
    unsigned short entry = convert_channel(r);
    entry <<= 4;
    entry |= convert_channel(g);
    entry <<= 4;
    entry |= convert_channel(b);
    return entry;
}

void install_palette(unsigned short *palette) {
    volatile unsigned short *reg = (unsigned short*) 0xff8240;
#if USE_MIDRES
    short numColors = 4;
#else
    short numColors = 16;
#endif
    for (short n=0; n<numColors; n++) *reg++ = *palette++;
}

void init_c2p_table() {
	unsigned short bayer[4][4] = {
		{0,  8, 2,10},
		{12, 4,14, 6},
		{ 3,11, 1, 9},
		{15, 7,13, 5}
	};
    set_doom_palette(W_CacheLumpName("PLAYPAL", PU_CACHE));
#if USE_MIDRES
    unsigned short stpalette[] = {stcolor(0,0,0), stcolor(85,85,85), stcolor(170,170,170), stcolor(255,255,255)};
    install_palette(stpalette);

    unsigned char* palette = W_CacheLumpName("PLAYPAL", PU_CACHE);
    for (int i=0; i<256; i++) {
        unsigned short r=palette[3*i], g=palette[3*i+1], b=palette[3*i+2];
        // printf("C %d: %d %d %d\n", i, r, g, b);
        // calculate brightness (0..765)
        unsigned short l = r+g+b;
        // calculate weights (0..255) of color indices 0, 1, 2, 3
        unsigned short w[] = {
            l < 256 ? 255 - l : 0,
            l < 256 ? l : (l < 512 ? 511 - l : 0),
            l < 256 ? 0 : (l < 512 ? l - 256 : 767 - l),
            l < 512 ? 0 : (l - 512),
        };
        // make weights cumulative
        for (int j=0; j<3; j++) w[j+1] += w[j];
        // renormalize weights into bayer range 0..15
        // for (int j=0; j<4; j++) w[j] >>= 4;
        // printf("  w: %2d %2d %2d %2d\n", w[0], w[1], w[2], w[3]);

        for (int phase=0; phase<4; phase++) {
            // iterate over 8 consecutive input pixels
            unsigned long combined_pdata = 0;
            for (int px = 0; px < 8; px++) {
                unsigned long pdata = 0;
                // per input pixel, iterate over two output pixels
                for (int opx = 2*px; opx < 2*px+2; opx++) {
                    // Fetch bayer threshold for output pixel.
                    unsigned short bayer_w = (bayer[phase][opx % 4] << 4) + 7;
                    // Iterate four possible output colors.
                    // Select first one that has cumulative weight >= bayer threshold.
                    // Apply bits to pixel data in opx position.
                    for (int oc = 0; oc < 4; oc++) {
                        if (oc < 3 && w[oc] < bayer_w) continue;
                        if (oc & 1) pdata |= 0x80000000 >> opx;
                        if (oc & 2) pdata |= 0x00008000 >> opx;
                        break;
                    }
                }
                c2p_table[phase][px][i] = pdata;
                combined_pdata |= pdata;
            }
        }
    }
#else
	for (int i=0; i<256; i++) {
        unsigned char *weights = mix_weights[i];
        for (int phase=0; phase<4; phase++) {
            for (int px=0; px<8; px++) {
                // Find the ST palette color index to fill the pixel with.
                int bayer_lwb = 0, bayer_upb = 0;
                for (int c=0; c<16; c++) {
                    bayer_upb += weights[c];
                    if (bayer[phase][px%4] >= bayer_lwb && bayer[phase][px%4] < bayer_upb) {
                        unsigned long pdata = 0;
                        if (c & 1) pdata |= 0x01000000;
                        if (c & 2) pdata |= 0x00010000;
                        if (c & 4) pdata |= 0x00000100;
                        if (c & 8) pdata |= 0x00000001;
                        pdata <<= 7-px;
                        c2p_table[phase][px][i] = pdata;
                        break; // Search for color is finished. Continue with next pixel.
                    }
                    bayer_lwb += weights[c];
                }
            }
        }
	}
#endif
}

inline void c2p(register unsigned char *out, const unsigned char *in, unsigned short pixels, unsigned char phase) {
#if USE_MIDRES
	while (pixels > 7) {
		register unsigned long pdata = 0;
        for(int i=0; i<8; i++) {
            pdata |= c2p_table[phase][i][*in++];
        }
        *(unsigned long*)out = pdata;
		pixels -= 8;
		out += 4;
	}
#else
	while (pixels > 15) {
		register unsigned int pdata; // 8 pixel data for use with movep
		for (int j=0; j<2; j++) {
			pdata = 0;
			for(int i=0; i<8; i++) {
				pdata |= c2p_table[phase][i][*in++];
			}
			move_p_ofs(out, pdata, j);
		}
		pixels -= 16;
		out += 8;
	}
#endif
}

const unsigned char subset[] = {0, 93, 241, 202, 253, 250, 38, 222, 216, 140, 131, 158, 116, 58, 249, 4};

void set_doom_palette(const unsigned char *colors) {
#if USE_MIDRES
    // do nothing
#else
    unsigned short stpalette[sizeof(subset)];
    for (int i=0; i<sizeof(subset); i++) {
        const unsigned char *c = &colors[3*subset[i]];
        stpalette[i] = stcolor(c[0], c[1], c[2]);
    }
    install_palette(stpalette);
#endif
}